---
title: "Data Management of DEPP cohort Evalaide - Matching"
author:
  - Pauline Martinot [UNICOG, NeuroSpin]
  - Bénédicte Colnet [Inria, Paris-Saclay]
date: "July 2021"
output:
  html_document:
    number_sections: no
    toc: yes
    toc_depth: 2
  pdf_document:
    toc: yes
abstract: | 
  This notebook concerns data from National assessment in 1st and 2nd grade in France : Matching. Reads the output of `13_Matching_script.R`.
---




# Matching plots


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
# Seed because random sampling and matching
set.seed(123)

# Libraries
library(MatchIt)
library(tidyverse)
library(ggplot2)
library(tidyr) # pivot
library(tableone)
library(dplyr)
library(purrr) # set_names
library(gmodels) # confidence intervals for summarise
library(data.table)
```


# 2018 Scenario 2


```{r}

# Parameters to set before launch of the pipeline
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2018" 
SCENARIO = 2 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl

load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
#load(paste0("~/Data/cohort_", ANNEE_COHORTE, "_", IMPUTED, "_joined_n.RData"))
load("~/Data/cohort_2018_imputed_ModRegLin_Gau_From_joined.RData")  # DATA_AGE_Gau_n

# Extract the data
results <- match.data(matched.data)
head(results)

# I want to add T1Math, T2Math and T3Math in zscore to the matched and non matched children.
# I want to add T1Math, T2Math and T3Math in zscore to the matched children
# I will use a merged for the selected data with (1) matched.data (2) joined_n_gau , by = ID_Eleve

matched.DATAGau <- merge(results[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T1_Language.1","ID_Eleve","weights","subclass")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

# matched_DATAGau <- merge(results[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T1_Language.1","ID_Eleve","weights","subclass")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

results <- matched.DATAGau

# I want to add T1Math, T2Math and T3Math in zscore to the non matched  children : data.to.match
colnames(data.to.match)
DATAGau.to.match <- merge(data.to.match[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T1_Language.1","ID_Eleve")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

data.to.match <- DATAGau.to.match

```


```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") # , "ID_Classe_CP"
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve

data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")

only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")


result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)

ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold")) +
  ylim(-0.5, 1.4)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())

ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))
```
# 2018 Scenario 3

```{r}

# Parameters to set before launch of the pipeline
SCENARIO = 3 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl
IMPUTED = "imputed"
ANNEE_COHORTE = "2018"
```

```{r}

load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
load("~/Data/cohort_2018_imputed_ModRegLin_Gau_From_joined.RData")  # DATA_AGE_Gau_n

# Extract the data
results <- match.data(matched.data)
head(results)

# I want to add T1Math, T2Math and T3Math in zscore to the matched and non matched children.
# I want to add T1Math, T2Math and T3Math in zscore to the matched children
# I will use a merged for the selected data with (1) matched.data (2) joined_n_gau , by = ID_Eleve

matched.DATAGau <- merge(results[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T1_Language.1","T2_Language", "ID_Eleve","weights","subclass")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

results <- matched.DATAGau

# I want to add T1Math, T2Math and T3Math in zscore to the non matched  children : data.to.match
colnames(data.to.match)
DATAGau.to.match <- merge(data.to.match[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T2_Language", "ID_Eleve")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

data.to.match <- DATAGau.to.match

```


```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "T2_Math", "T2_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") 
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language", "T2_Math", "T2_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)", "Math at T2 (mean)", "Language at T2 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve

data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")

only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")

result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)

ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold"))+
  ylim(-0.5, 1.4)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())

ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))
```





# 2019 Scenario 2


```{r}
knitr::opts_chunk$set(echo = TRUE)
# Seed because random sampling and matching
set.seed(123)

# Libraries
library(MatchIt)
library(tidyverse)
library(ggplot2)
library(tidyr) # pivot
library(tableone)
library(dplyr)
library(purrr) # set_names
library(gmodels) # confidence intervals for summarise
library(data.table)

# Parameters to set before launch of the pipeline
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2019"
SCENARIO = 2 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl

load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
load("~/Data/cohort_2019_imputed_ModRegLin_Gau_From_joined.RData")  # DATA_AGE_Gau_n

# Extract the data
results <- match.data(matched.data)
head(results)

# I want to add T1Math, T2Math and T3Math in zscore to the matched and non matched children.
# I want to add T1Math, T2Math and T3Math in zscore to the matched children
# I will use a merged for the selected data with (1) matched.data (2) joined_n_gau , by = ID_Eleve
colnames(results)

matched.DATAGau <- merge(results[, c("T1_Ecri_Nombre_P","T1_Lire_Nombre_P","T1_Resoud_Pb_P","T1_Denombrer_P",
                                     "T1_Compa_Nombre_P","T1_Ligne_Num_P","T1_Language","Categ_Etab_CP",
                                     "IPS_Etab_CP","Age_CP","Sexe","T1_Language.1","ID_Eleve","weights",
                                     "subclass")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

results <- matched.DATAGau

# I want to add T1Math, T2Math and T3Math in zscore to the non matched  children : data.to.match
colnames(data.to.match)
DATAGau.to.match <- merge(data.to.match[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T1_Language.1","ID_Eleve")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

data.to.match <- DATAGau.to.match

```

```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") # , "ID_Classe_CP"
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve
```


```{r}
data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")
```

```{r}
only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")
```


```{r, echo = FALSE, message = FALSE, warning = FALSE }
result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)
```


```{r}
ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold")) +
  ylim(-0.5, 1.4)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())
```


```{r eval=FALSE, include=FALSE}
ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))
```

# 2019 Scenario 3

```{r}

# Parameters to set before launch of the pipeline
SCENARIO = 3 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl

load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
load("~/Data/cohort_2019_imputed_ModRegLin_Gau_From_joined.RData")  # DATA_AGE_Gau_n

# Extract the data
results <- match.data(matched.data)
head(results)

# I want to add T1Math, T2Math and T3Math in zscore to the matched and non matched children.
# I want to add T1Math, T2Math and T3Math in zscore to the matched children
# I will use a merged for the selected data with (1) matched.data (2) joined_n_gau , by = ID_Eleve

matched.DATAGau <- merge(results[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T1_Language.1","T2_Language", "ID_Eleve","weights","subclass")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

results <- matched.DATAGau

# I want to add T1Math, T2Math and T3Math in zscore to the non matched  children : data.to.match
colnames(data.to.match)
DATAGau.to.match <- merge(data.to.match[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T2_Language", "ID_Eleve")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

data.to.match <- DATAGau.to.match

```

```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "T2_Math", "T2_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") 
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language", "T2_Math", "T2_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)", "Math at T2 (mean)", "Language at T2 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve
```


```{r}
data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")
```

```{r}
only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")
```


```{r, echo = FALSE, message = FALSE, warning = FALSE }
result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)
```


```{r}
ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold")) +
  ylim(-0.5, 1.4)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())
```


```{r eval=FALSE, include=FALSE}
ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))
```




# 2020 Scenario 2


```{r}

# Parameters to set before launch of the pipeline
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2020"
SCENARIO = 2 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl

load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
load("~/Data/cohort_2020_imputed_ModRegLin_Gau_From_joined.RData")  # DATA_AGE_Gau_n

# Extract the data
results <- match.data(matched.data)
head(results)

# I want to add T1Math, T2Math and T3Math in zscore to the matched and non matched children.
# I want to add T1Math, T2Math and T3Math in zscore to the matched children
# I will use a merged for the selected data with (1) matched.data (2) joined_n_gau , by = ID_Eleve
colnames(results)

matched.DATAGau <- merge(results[, c("T1_Ecri_Nombre_P","T1_Lire_Nombre_P","T1_Resoud_Pb_P","T1_Denombrer_P",
                                     "T1_Compa_Nombre_P","T1_Ligne_Num_P","T1_Language","Categ_Etab_CP",
                                     "IPS_Etab_CP","Age_CP","Sexe","T1_Language.1","ID_Eleve","weights",
                                     "subclass")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

results <- matched.DATAGau

# I want to add T1Math, T2Math and T3Math in zscore to the non matched  children : data.to.match
colnames(data.to.match)
DATAGau.to.match <- merge(data.to.match[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T1_Language.1","ID_Eleve")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

data.to.match <- DATAGau.to.match

```

```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") # , "ID_Classe_CP"
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve
```


```{r}
data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")
```

```{r}
only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")
```


```{r, echo = FALSE, message = FALSE, warning = FALSE }
result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)
```


```{r}
ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold")) +
  ylim(-0.5, 1.4)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())
```


```{r eval=FALSE, include=FALSE}
ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))
```

# 2020 Scenario 3

```{r}

# Parameters to set before launch of the pipeline
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2020"
SCENARIO = 3 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl

# Parameters to set before launch of the pipeline
load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
load("~/Data/cohort_2020_imputed_ModRegLin_Gau_From_joined.RData")  # DATA_AGE_Gau_n

# Extract the data
results <- match.data(matched.data)
head(results)

# I want to add T1Math, T2Math and T3Math in zscore to the matched and non matched children.
# I want to add T1Math, T2Math and T3Math in zscore to the matched children
# I will use a merged for the selected data with (1) matched.data (2) joined_n_gau , by = ID_Eleve
colnames(results)
matched.DATAGau <- merge(results[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T1_Language.1","T2_Language", "ID_Eleve","weights","subclass")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

results <- matched.DATAGau

# I want to add T1Math, T2Math and T3Math in zscore to the non matched  children : data.to.match
colnames(data.to.match)
DATAGau.to.match <- merge(data.to.match[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T2_Language", "ID_Eleve")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

data.to.match <- DATAGau.to.match

```

```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "T2_Math", "T2_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") 
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language", "T2_Math", "T2_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)", "Math at T2 (mean)", "Language at T2 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve
```


```{r}
data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")
```

```{r}
only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")
```


```{r, echo = FALSE, message = FALSE, warning = FALSE }
result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)
```


```{r}
ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold")) +
  ylim(-0.5,1.4)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())
```


```{r eval=FALSE, include=FALSE}
ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))
```


# 2021 Scenario 2


```{r}

# Parameters to set before launch of the pipeline
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2021" 
SCENARIO = 2 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl

load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
load("~/Data/cohort_2021_imputed_ModRegLin_Gau_From_joined.RData")  # DATA_AGE_Gau_n

# Extract the data
results <- match.data(matched.data)
head(results)

# I want to add T1Math, T2Math and T3Math in zscore to the matched and non matched children.
# I want to add T1Math, T2Math and T3Math in zscore to the matched children
# I will use a merged for the selected data with (1) matched.data (2) joined_n_gau , by = ID_Eleve
colnames(results)

matched.DATAGau <- merge(results[, c("T1_Ecri_Nombre_P","T1_Lire_Nombre_P","T1_Resoud_Pb_P","T1_Denombrer_P",
                                     "T1_Compa_Nombre_P","T1_Ligne_Num_P","T1_Language","Categ_Etab_CP",
                                     "IPS_Etab_CP","Age_CP","Sexe","T1_Language.1","ID_Eleve","weights",
                                     "subclass")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

results <- matched.DATAGau

# I want to add T1Math, T2Math and T3Math in zscore to the non matched  children : data.to.match
colnames(data.to.match)
DATAGau.to.match <- merge(data.to.match[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T1_Language.1","ID_Eleve")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

data.to.match <- DATAGau.to.match

```

```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") # , "ID_Classe_CP"
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve
```


```{r}
data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")
```

```{r}
only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")
```


```{r, echo = FALSE, message = FALSE, warning = FALSE }
result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)
```


```{r}
ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold")) +
  ylim(-0.5, 1.4)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())
```


```{r eval=FALSE, include=FALSE}
ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen2_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))
```


# 2021 Scenario 3

```{r}
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2021" 
SCENARIO = 3 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl

load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
load("~/Data/cohort_2021_imputed_ModRegLin_Gau_From_joined.RData")  # DATA_AGE_Gau_n

# Extract the data
results <- match.data(matched.data)
head(results)

# I want to add T1Math, T2Math and T3Math in zscore to the matched and non matched children.
# I want to add T1Math, T2Math and T3Math in zscore to the matched children
# I will use a merged for the selected data with (1) matched.data (2) joined_n_gau , by = ID_Eleve

matched.DATAGau <- merge(results[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T1_Language.1","T2_Language", "ID_Eleve","weights","subclass")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

results <- matched.DATAGau

# I want to add T1Math, T2Math and T3Math in zscore to the non matched  children : data.to.match
colnames(data.to.match)
DATAGau.to.match <- merge(data.to.match[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T2_Language", "ID_Eleve")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

data.to.match <- DATAGau.to.match

```

```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "T2_Math", "T2_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") 
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language", "T2_Math", "T2_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)", "Math at T2 (mean)", "Language at T2 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve
```


```{r}
data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")
```

```{r}
only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")
```


```{r, echo = FALSE, message = FALSE, warning = FALSE }
result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)
```


```{r}
ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold")) +
  ylim(-0.5, 1.4)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())
```


```{r eval=FALSE, include=FALSE}
ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen3_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))


```



# 2018 - Scenario 1

```{r}

# Parameters to set before launch of the pipeline
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2018" 
SCENARIO = 1 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl

```

```{r}

load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
load("~/Data/cohort_2018_imputed_ModRegLin_Gau_From_joined.RData")  # DATA_AGE_Gau_n

# Extract the data
results <- match.data(matched.data)
head(results)

# I want to add T1Math, T2Math and T3Math in zscore to the matched and non matched children.
# I want to add T1Math, T2Math and T3Math in zscore to the matched children
# I will use a merged for the selected data with (1) matched.data (2) joined_n_gau , by = ID_Eleve

matched.DATAGau <- merge(results[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "T1_Language.1","ID_Eleve","weights","subclass")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

results <- matched.DATAGau

# I want to add T1Math, T2Math and T3Math in zscore to the non matched  children : data.to.match
colnames(data.to.match)
DATAGau.to.match <- merge(data.to.match[, c("T1_Ecri_Nombre_P", "T1_Lire_Nombre_P", "T1_Resoud_Pb_P", "T1_Denombrer_P", "T1_Compa_Nombre_P", "T1_Ligne_Num_P", "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP", "Sexe", "ID_Eleve")], DATA_AGE_gau_Base_n[, c("ID_Eleve", "T1_Math", "T2_Math", "T3_Math")], by = c("ID_Eleve"))

data.to.match <- DATAGau.to.match

```

```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") # , "ID_Classe_CP"
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve

data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")

only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")

result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)

ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold")) +
  ylim(-0.5, 1.4)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())
```


```{r eval=FALSE, include=FALSE}
ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))
```

# 2019 - Scenario 1

```{r}

# Parameters to set before launch of the pipeline
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2019" 
SCENARIO = 1 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl

load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
load(paste0("~/Data/cohort_", ANNEE_COHORTE, "_", IMPUTED, "_joined_n.RData"))


# Extract the data
results <- match.data(matched.data)
head(results)

```

```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") # , "ID_Classe_CP"
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve
```


```{r}
data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")
```

```{r}
only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")
```


```{r, echo = FALSE, message = FALSE, warning = FALSE }
result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)
```


```{r}
ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold")) +
  ylim(60, 95)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())
```


```{r eval=FALSE, include=FALSE}
ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))
```


# 2020 - Scenario 1

```{r}

# Parameters to set before launch of the pipeline
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2020" 
SCENARIO = 1 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl

load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
load(paste0("~/Data/cohort_", ANNEE_COHORTE, "_", IMPUTED, "_joined_n.RData"))


# Extract the data
results <- match.data(matched.data)
head(results)

```

```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") # , "ID_Classe_CP"
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve
```


```{r}
data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")
```

```{r}
only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")
```


```{r, echo = FALSE, message = FALSE, warning = FALSE }
result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)
```


```{r}
ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold")) +
  ylim(60, 95)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())
```


```{r eval=FALSE, include=FALSE}
ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))
```

# 2021 - Scenario 1

```{r}

# Parameters to set before launch of the pipeline
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2021" 
SCENARIO = 1 # "2" "3"
ESTIMAND = "ATT" # effect of being a girl

load(paste0("~/Data/output_13_Matching_", IMPUTED, "_", ANNEE_COHORTE, "_SCENARIO_", SCENARIO, "_", ESTIMAND, ".RData"))
load(paste0("~/Data/cohort_", ANNEE_COHORTE, "_", IMPUTED, "_joined_n.RData"))


# Extract the data
results <- match.data(matched.data)
head(results)

```

```{r}
covariates_used_for_matching <- c(Math_T1_P, "T1_Language", "Categ_Etab_CP", "IPS_Etab_CP", "Age_CP") # , "ID_Classe_CP"
covariates_used_for_matching_grades  <- c(Math_T1_P, "T1_Language")

data.for.plot <- results[, c(covariates_used_for_matching, "Sexe")]
data.for.plot$Matching <- rep("After", nrow(data.for.plot))
temp <- data.to.match[, c(covariates_used_for_matching, "Sexe")]
temp$Matching <- rep("Before", nrow(temp))

data.for.plot <- rbind(data.for.plot, temp)
data.for.plot$Gender <- ifelse(data.for.plot$Sexe == 1, "Girl", "Boy")
results$Gender <- ifelse(results$Sexe == 1, "Girl", "Boy")

covariates_used_for_matching_grades_better_names <- c("Writing numbers at T1", "Reading numbers at T1", "Problem solving at T1", "Enumerating quantities at T1", "Number comparison at T1", "Number line at T1", "Language at T1 (mean)")
setnames(data.for.plot, old = covariates_used_for_matching_grades, new = covariates_used_for_matching_grades_better_names) 
```

### Assessing the efficacy of the matching

```{r}
data.for.plot %>%
  group_by(Matching, Gender) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = "Gender", values_from = "Mean") %>%
  mutate(Mean.difference = Girl - Boy) %>%
  ggplot(aes(x = Mean.difference, y = Variable, color = Matching)) +
  geom_point(size = 6) +
  theme_bw() +
  xlim(-3.5, 3.5) +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7, size = 1) +
  xlab("Gender \n difference at T1") +
  ylab("") +
  theme(legend.position = "none", text = element_text(size = 20, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Efficacy-of-matching.svg"), width = 10, height = 6)
```

```{r}
data.for.plot %>%
  group_by(Matching) %>%
  summarise_at(covariates_used_for_matching_grades_better_names, mean, na.rm = TRUE) %>%
  pivot_longer(cols = covariates_used_for_matching_grades_better_names, names_to = "Variable", values_to = "Mean") %>%
  ggplot(aes(x = Mean, y = Variable, color = Matching)) +
  geom_point(size = 5) +
  theme_bw() +
  xlab("Mean difference") +
  ylab("") +
  scale_color_manual(values = c("#E69F00", "#999999")) +
  theme(legend.position = "right", text = element_text(size = 15, face = "bold"))
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Bias-due-to-poor-overlap.svg"), width = 10, height = 6)
```


### Matching plots

```{r}
id.matched <- results$ID_Eleve
```


```{r}
data.to.match$Type <- case_when(data.to.match$Sexe == "Girls" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Girls",
                            data.to.match$Sexe == "Boys" & data.to.match$ID_Eleve %in% id.matched ~ "Matched Boys",
                            data.to.match$Sexe == "Girls" & !data.to.match$ID_Eleve %in% id.matched ~ "Unmatched Girls",
                            data.to.match$Sexe == "Boys" & !data.to.match$ID_Eleve %in% id.matched  ~ "Unmatched Boys")
```

```{r}
only.matched.children <- data.to.match[data.to.match$ID_Eleve %in% id.matched,]
only.matched.children$Matched <- rep("Matched", nrow(only.matched.children))
data.to.match$Matched <- rep("Original cohort", nrow(data.to.match))
result.for.plot <- rbind(only.matched.children, data.to.match)


result.for.plot$Gender   <- ifelse(result.for.plot$Sexe == 1, "Girl", "Boy")
```


```{r, echo = FALSE, message = FALSE, warning = FALSE }
result.for.plot.bis <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  group_by(Gender, Test, Matched) %>%
  summarise(mean = ci(Rank)[1], 
            lowCI = ci(Rank)[2],
            hiCI = ci(Rank)[3],
            sd = sd(Rank))

result.for.plot.bis$Test <- substr(result.for.plot.bis$Test, 1, 2)
```


```{r}
ggplot(result.for.plot.bis, aes(x = Test, y =mean, color = Gender, linetype = Matched, group = interaction(Matched,Gender))) +
  geom_point(size = 5) +
  geom_line(size = 2) +
  geom_errorbar(aes(ymin=lowCI, ymax=hiCI), width=.05, size = 2) +
  theme_minimal() +
  xlab("") +
  ylab("Results (z score)") +
  scale_color_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys (matched)", "Girls")) +
  theme(legend.position = "none",
        axis.title.x = element_text(color="black", size= 20, face = "bold"),
        axis.title.y = element_text(color="black", size=20 , face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"), 
        text = element_text(size = 20, face = "bold")) +
  ylim(60, 95)
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Matching_Main_results.svg"), width = 4, height = 5)
```


```{r}
plot.proportions <- result.for.plot %>%
  pivot_longer(cols = c("T1_Math","T2_Math", "T3_Math"), names_to = "Test", values_to = "Rank")  %>%
  mutate(Rank = as.integer(round(10*Rank, 0))) %>%
  group_by(Gender, Test, Matched, Rank) %>%
  summarise(count = n())
```


```{r eval=FALSE, include=FALSE}
ggplot(plot.proportions, aes(x = as.factor(Rank), fill = Gender, y = count)) +
  geom_bar(position="fill", stat="identity") +
  facet_grid(Test ~ Matched) +
  scale_fill_manual(values = c("#000066", "#FF3333","#000066", "#FF3333"), labels = c("Boys", "Girls")) +
  theme_bw() +
  ylab("Proportion") +
  geom_hline(yintercept = 0.5, size = 1.2, color = "white", linetype = "dashed") +
  xlab("Decile")
  ggsave(paste0("~/img/", ANNEE_COHORTE,"/", ANNEE_COHORTE,"_Graph_scen1_Matching_Main_results_per_decile.svg"), width = 10, height = 6)
```

### Analysis to report with confidence intervals

```{r}
library("lmtest") #coeftest  
library("sandwich") #vcovCL - intervalles de confiance
library("zoo")

fit <- lm(T3_Math ~ Gender + Categ_Etab_CP + IPS_Etab_CP + Age_CP + T1_Language + T1_Ecri_Nombre_P + T1_Lire_Nombre_P + T1_Resoud_Pb_P + T1_Denombrer_P + T1_Compa_Nombre_P + T1_Ligne_Num_P, data = results, weights = weights)


coeftest(fit, vcov. = vcovCL, cluster = ~subclass)

# Number of pairs

length(unique(results$subclass))
```



