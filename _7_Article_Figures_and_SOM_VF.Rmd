---
title: "Graph_1_CohensD"
author: 
  - Pauline Martinot [UNICOG, NeuroSpin]
date: "July 2023"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, include = TRUE)

library(tidyverse)
library(dplyr)
library(ggplot2)
library(ciTools)
library(gmodels)

```

# Parameters to set before launch of the pipeline

```{r}

IMPUTED = "imputed" # "non-imputed"

ANNEE_COHORTE = 2018 # 2018 # 2020 # 2019

```


Emergence of a highly reproducible gender gap in Math, Number Line and Pb solving in the first year of schooling

# Fig 1B - Library to set before launch of the pipeline

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, include = TRUE)

library(tidyverse)
library(dplyr)
library(rmarkdown)
library(ggplot2)
library(reshape2)
library(alluvial)
library(patchwork)
library(ciTools)
library(gmodels)

load(paste0("~/Data/cohort_", ANNEE_COHORTE, "_", IMPUTED, "_ModRegLin_Gau_From_joined.RData"))

```


Data implemented on the document 


### Math 10 categ ANOVA

```{r}

DATA_AGE_gau_Base_n %>% 
  group_by(Categ_10c_CP, Sexe_Boys, Categ_Etab_CP) %>%
  summarise(T3 = mean(T3_Math), T1 = mean(T1_Math), T2 = mean(T2_Math)) %>%
  pivot_longer(cols =c("T1", "T2", "T3"), names_to = "Period", values_to = "Grade") %>%
  ggplot(aes(x = Categ_10c_CP, y = Grade, group = interaction(Categ_Etab_CP, Sexe_Boys), color = Sexe_Boys)) +
  geom_line() +
  geom_point(size = 2) +
  facet_wrap(~Period) +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) + 
  theme(axis.line.x = element_line(arrow = arrow(length = unit(2, "mm")))) + 
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  ylab("Math level (zscore)") +
  xlab("10 social categories of schools") + 
  coord_cartesian(ylim=c(-0.75,0.50)) + 
  geom_hline(yintercept = 0, alpha = 0.2) +
  scale_color_manual(values=c("#000066", "#FF3333"))

ggsave(paste0("~/img/", ANNEE_COHORTE, "/Graph_2A_", ANNEE_COHORTE, "_average_level_anova_math_10c_CohenD.svg"), width = 9, height = 6)

```



# Fig 1C : Distribution of gender gap in Math ranks at T1 T2 T3

### Data selection : normal age +++


```{r}

load(file = paste0("~/Data/cohort_", ANNEE_COHORTE, "_imputed_joined_n.RData"))


joined2 <- joined_n[, c("ID_etab_class",  "Sexe", "T1_Math", "T1_Math_Rank",
                        "T2_Math_Rank", "T3_Math_Rank",
                        "D_T1_Math", "D_T1_Math_Rank", "D_T2_Math", "D_T2_Math_Rank",
                        "D_T3_Math", "D_T3_Math_Rank", 
                        "T1_Language", "T3_Lang_Rank", "T2_Lang_Rank", "T1_Lang_Rank", 
                        "D_T1_Language", "D_T1_Lang_Rank", "D_T2_Language", "D_T2_Lang_Rank",
                        "D_T3_Language", "D_T3_Lang_Rank" )]

glimpse(joined2)

names(joined2)[names(joined2) == "Sexe"] <- "Sexe_Boys" 
joined2$Sexe_Boys <- as.factor(joined2$Sexe_Boys)
summary(joined2$Sexe_Boys)


```


### Math Ranks

```{r echo=TRUE}


data_for_plot <- joined2[, c("T3_Math_Rank", "T2_Math_Rank", "T1_Math_Rank", "Sexe_Boys")]

# DATA_AGE = data_depp[(data_depp$Age_CP >= 64) & (data_depp$Age_CP <= 86) ,]

data_for_plot <- pivot_longer(data_for_plot, cols = c("T1_Math_Rank", "T2_Math_Rank", "T3_Math_Rank"), names_to = "Period", values_to = "Grade")
data_for_plot$Period <- substr(data_for_plot$Period , 1, 2)


ggplot(data_for_plot, aes(x = Grade*100, fill = Sexe_Boys, group = Sexe_Boys)) +
  facet_wrap(~ Period, ncol = 3) +
  geom_histogram(position = "identity", alpha = 0.6,
                 binwidth = 2.5 ,
                 breaks=seq(0, 100, by = 4)) +
  scale_fill_manual (values = c("#000066", "#FF3333"), labels = c( "Boys", "Girls")) +
  xlab("Math level (Percentile rank)") +
  theme_minimal() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) + 
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1))
  


ggsave(file = paste0("~/img/", ANNEE_COHORTE, "/Graph_2C_distribution_math_", ANNEE_COHORTE, "_CohenD.svg"), width = 9, height = 3)

rm(data_for_plot)

```

# Fig 2A Cohen s d in math and language

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = TRUE)

library(tidyverse)
library(dplyr)
library(ggplot2)
library(ciTools)
library(rstatix)

```


```{r}

# Data T1


DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T1", "Sexe_Boys", "T1_Math")]

DATA_Cohen$Age_T1       <- as.factor(DATA_Cohen$Age_T1)
DATA_Cohen$Sexe_Boys    <- as.factor(DATA_Cohen$Sexe_Boys)
DATA_Cohen$T1_Math      <- as.numeric(DATA_Cohen$T1_Math)
summary(DATA_Cohen$Age_T1)
summary(DATA_Cohen$Sexe_Boys)
summary(DATA_Cohen$T1_Math)

DATA_C5 <- DATA_Cohen %>%
  group_by(Age_T1) %>%
  cohens_d(T1_Math ~ Sexe_Boys, var.equal = FALSE, ref.group = "Boys") 
colnames(DATA_C5)[1] <- "Time"
DATA_T1 <- DATA_C5[, c("Age_T1", "effsize", "Time")]

# Data T2

DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T2", "Sexe_Boys", "T2_Math")]
DATA_Cohen$Age_T2 <- as.character(DATA_Cohen$Age_T2)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(Age_T2) %>%
  cohens_d(T2_Math ~ Sexe_Boys, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C6)[1] <- "Time"
DATA_T2 <- DATA_C6[, c("Age_T2", "effsize", "Time")]
rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T3", "Sexe_Boys", "T3_Math")]
DATA_Cohen$Age_T3 <- as.character(DATA_Cohen$Age_T3)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(Age_T3) %>%
  cohens_d(T3_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"
DATA_T3 <- DATA_C7[, c("Age_T3", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "Age"
colnames(DATA_T2)[1] <- "Age"
colnames(DATA_T3)[1] <- "Age"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)


rm( DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$Age     <- as.numeric(DATA30_Cohen$Age)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Age, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Age when taking the test (month)") +
  coord_cartesian(ylim=c(-0.066,0.28)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

ggsave(file = paste0("~/img/", ANNEE_COHORTE, "/Graph_3A_DataGau_n_Age_MATH_Cohen30_n_", ANNEE_COHORTE, "_adapted_scale.svg"), width = 7, height = 5)



```

# Fig 2B Lang Age and schooling DATA_AGE_gau_Base_n

```{r}
# T1 Language on DATA30_n

# Data T1

DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T1", "Sexe_Boys", "T1_Language")] 

DATA_Cohen$Age_T1 <- as.character(DATA_Cohen$Age_T1)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C5 <- DATA_Cohen %>%
  group_by(Age_T1) %>%
  cohens_d(T1_Language ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C5)[1] <- "Time"

DATA_T1 <- DATA_C5[, c("Age_T1", "effsize", "Time")]

rm(DATA_C5, DATA_Cohen)

# Data T2

DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T2", "Sexe_Boys", "T2_Language")]

DATA_Cohen$Age_T2 <- as.character(DATA_Cohen$Age_T2)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(Age_T2) %>%
  cohens_d(T2_Language ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C6)[1] <- "Time"

DATA_T2 <- DATA_C6[, c("Age_T2", "effsize", "Time")]

rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T3", "Sexe_Boys", "T3_Language")]

DATA_Cohen$Age_T3 <- as.character(DATA_Cohen$Age_T3)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(Age_T3) %>%
  cohens_d(T3_Language ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"

DATA_T3 <- DATA_C7[, c("Age_T3", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "Age"
colnames(DATA_T2)[1] <- "Age"
colnames(DATA_T3)[1] <- "Age"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)

rm(DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$Age     <- as.numeric(DATA30_Cohen$Age)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Age, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  ylab("Cohen's D Language") +
  xlab("Age when taking the test (month)") +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) + 
  coord_cartesian(ylim=c(-0.25, 0)) +
  scale_color_manual(legend_title, values=c("#66CC00", "#006600","#003300")) 


ggsave(file = paste0("~/img/", ANNEE_COHORTE, "/Graph_3A_DATA_AGE_gau_Base_n_Age_Language_Cohen30_n_", ANNEE_COHORTE, "adapted_scale.svg"), width = 7, height = 5)


```

# Fig 3 Matching : cf Matching scripts


# SOM

### Fig S1


joined                = data_depp imputed and classes variables
Joined_Fin_3          = joined that underwent gaussianization of its variables, but not all of them
DATA_AGE_gau_Base_n   = Age 69 to 80 months
DATA_AGE_gau_Base_30n = Age 69 to 80 months with classes of 30% boys girls

For figure 1 we need Joined_Fin_3 as we want data that underwent gaussianization for Cohen s D.
Age_CP = gaussianized

```{r}

load(paste0("~/Data/cohort_", ANNEE_COHORTE, "_", IMPUTED, "_ModRegLin_Gau_From_joined.RData"))


```


##### Graph Age effect on results in Math at T1 and language at T1

Within the total population, do we find higher math and language skills at younger and older ages?


```{r}

DATA_AGE = Joined_Fin_3[(Joined_Fin_3$Age_T1 >= 64) & (Joined_Fin_3$Age_T1 <= 86) ,]


```


###### Math x Age colors T1 T2 T3


```{r}
# Math T1

DATA_AGE$Age_T1 <- as.factor(DATA_AGE$Age_T1)
DATA_AGE$T1_Math <- as.numeric(DATA_AGE$T1_Math)
DATA_AGE$Age_CAT <- as.factor(DATA_AGE$Age_CAT)

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T1_Math, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  coord_cartesian(ylim=c(-1.1, 0.70)) +
  xlab("Age in first grade (month)") +
  ylab("Math level at T1 (Cohen's D)") +
  geom_hline(yintercept = 0, alpha = 0.2) +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))

ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Math_T1_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)


# Math T2

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T2_Math, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  coord_cartesian(ylim=c(-1.1, 0.70)) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  xlab("Age in first grade (month)") +
  ylab("Math level at T2 (Cohen's D)") +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))


ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Math_T2_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)

# Math T3

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T3_Math, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  coord_cartesian(ylim=c(-1.1, 0.75)) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  xlab("Age in first grade (month)") +
  ylab("Math level at T3 (Cohen's D)") +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))


ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Math_T3_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)



```


###### Language x Age effect  T1 T2 T3

```{r echo=TRUE}


# Lang T1 

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T1_Language, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  coord_cartesian(ylim=c(-1.25,1)) +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  xlab("Age in first grade (month)") +
  ylab("Lang level at T1 (Cohen's D)") +
  geom_hline(yintercept = 0, alpha = 0.2) +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))



ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Lang_T1_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)

# Lang T2

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T2_Language, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  coord_cartesian(ylim=c(-1.25, 1)) +
  xlab("Age in first grade (month)") +
  ylab("Lang level at T2 (Cohen's D)") +
  geom_hline(yintercept = 0, alpha = 0.2) +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))


ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Lang_T2_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)

# Lang T3

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T3_Language, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  coord_cartesian(ylim=c(-1.25, 1)) +
  xlab("Age in first grade (month)") +
  ylab("Lang level at T3 (Cohen's D)") +
  geom_hline(yintercept = 0, alpha = 0.2) +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))


ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Lang_T3_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)


```


#### Graph Math x Total age population x Level x 10 categories and at T1, T2, T3 - TOTAL AGE

```{r}
# Math T1

DATA_AGE %>%
  group_by(Categ_10c_CP, Categ_Etab_CP) %>%
  summarise(mean_T1 = mean(T1_Math)) %>%
  ggplot(aes(x = Categ_10c_CP, y = mean_T1, group = Categ_Etab_CP, color = Categ_10c_CP)) +
  geom_point(size = 4) +
  scale_color_manual(values=c("darkblue", "dodgerblue" , "darkgreen", "seagreen", "limegreen",
                              "chartreuse2", "#feb24c" ,"#fd8d3c", "#e31a1c", "darkred")) +
  geom_line(size = 2) +
  coord_cartesian(ylim=c(-0.65,0.30)) +
  xlab("10 social categories of school") +
  ylab("Math Performance in Cohen's D at T1")  +
  geom_hline(yintercept = 0, alpha = 0.2) +
  theme_light() +
  theme(panel.background = element_rect(size = 0.1, linetype = 'solid',
                                colour = "grey")) +
  theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.spacing = unit(2, "lines")) +
  theme(axis.line.x = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1)) 

ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1C_",ANNEE_COHORTE,"_10Categ_Total_Math_T1_CohenD.svg"), width = 6, height = 5)

# Math T2

DATA_AGE %>%
  group_by(Categ_10c_CP, Categ_Etab_CP) %>%
  summarise(mean_T2 = mean(T2_Math)) %>%
  ggplot(aes(x = Categ_10c_CP, y = mean_T2, group = Categ_Etab_CP, color = Categ_10c_CP)) +
  geom_point(size = 4) +
  scale_color_manual(values=c("darkblue", "dodgerblue" , "darkgreen", "seagreen", "limegreen",
                              "chartreuse2", "#feb24c" ,"#fd8d3c", "#e31a1c", "darkred")) +
  geom_line(size = 2) +
  coord_cartesian(ylim=c(-0.65,0.30)) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  xlab("10 social categories of school") +
  ylab("Math Performance in Cohen's D at T2")  +
  theme_light() +
  theme(panel.background = element_rect(size = 0.1, linetype = 'solid',
                                colour = "grey")) +
  theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.spacing = unit(2, "lines")) +
  theme(axis.line.x = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))

ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1C_",ANNEE_COHORTE,"_10Categ_Total_Math_T2_CohenD.svg"), width = 6, height = 5)

# Math T3

DATA_AGE %>%
  group_by(Categ_10c_CP, Categ_Etab_CP) %>%
  summarise(mean_T3 = mean(T3_Math)) %>%
  ggplot(aes(x = Categ_10c_CP, y = mean_T3, group = Categ_Etab_CP, color = Categ_10c_CP)) +
  geom_point(size = 4) +
  scale_color_manual(values=c("darkblue", "dodgerblue" , "darkgreen", "seagreen", "limegreen",
                              "chartreuse2", "#feb24c" ,"#fd8d3c", "#e31a1c", "darkred")) +
  geom_line(size = 2) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  coord_cartesian(ylim=c(-0.65,0.40)) +
  xlab("10 social categories of school") +
  ylab("Math Performance in Cohen's D at T3")  +
  theme_light() +
  theme(panel.background = element_rect(size = 0.1, linetype = 'solid',
                                colour = "grey")) +
  theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.spacing = unit(2, "lines")) +
  theme(axis.line.x = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))

ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1C_",ANNEE_COHORTE,"_10Categ_Total_Math_T3_CohenD.svg"), width = 6, height = 5)

```


#### Graph Language x Total age population

```{r}

# Lang T1

DATA_AGE %>%
  group_by(Categ_10c_CP, Categ_Etab_CP) %>%
  summarise(mean_T1 = mean(T1_Language)) %>%
  ggplot(aes(x = Categ_10c_CP, y = mean_T1, group = Categ_Etab_CP, color = Categ_10c_CP)) +
  geom_point(size = 4) +
  scale_color_manual(values=c("darkblue", "dodgerblue" , "darkgreen", "seagreen", "limegreen",
                              "chartreuse2", "#feb24c" ,"#fd8d3c", "#e31a1c", "darkred")) +
  geom_line(size = 2) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  coord_cartesian(ylim=c(-0.76,0.4)) +
  xlab("10 social categories of school") +
  ylab("Lang Performance in Cohen's D at T1")  +
  theme_light() +
  theme(panel.background = element_rect(size = 0.1, linetype = 'solid',
                                colour = "grey")) +
  theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.spacing = unit(2, "lines")) +
  theme(axis.line.x = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))

ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1C_",ANNEE_COHORTE,"_10Categ_Total_Lang_T1_CohenD.svg"), width = 9, height = 6, dpi = 150)

# Lang T2

DATA_AGE %>%
  group_by(Categ_10c_CP, Categ_Etab_CP) %>%
  summarise(mean_T2 = mean(T2_Language)) %>%
  ggplot(aes(x = Categ_10c_CP, y = mean_T2, group = Categ_Etab_CP, color = Categ_10c_CP)) +
  geom_point(size = 4) +
  scale_color_manual(values=c("darkblue", "dodgerblue" , "darkgreen", "seagreen", "limegreen",
                              "chartreuse2", "#feb24c" ,"#fd8d3c", "#e31a1c", "darkred")) +
  geom_line(size = 2) +
  coord_cartesian(ylim=c(-0.76,0.4)) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  xlab("10 social categories of school") +
  ylab("Lang Performance in Cohen's D at T2")  +
  theme_light() +
  theme(panel.background = element_rect(size = 0.1, linetype = 'solid',
                                colour = "grey")) +
  theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.spacing = unit(2, "lines")) +
  theme(axis.line.x = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))

ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1C_",ANNEE_COHORTE,"_10Categ_Total_Lang_T2_CohenD.svg"), width = 9, height = 6, dpi = 150)

# Lang T3

DATA_AGE %>%
  group_by(Categ_10c_CP, Categ_Etab_CP) %>%
  summarise(mean_T3 = mean(T3_Language)) %>%
  ggplot(aes(x = Categ_10c_CP, y = mean_T3, group = Categ_Etab_CP, color = Categ_10c_CP)) +
  geom_point(size = 4) +
  scale_color_manual(values=c("darkblue", "dodgerblue" , "darkgreen", "seagreen", "limegreen",
                              "chartreuse2", "#feb24c" ,"#fd8d3c", "#e31a1c", "darkred")) +
  geom_line(size = 2) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  coord_cartesian(ylim=c(-0.76,0.45)) +
  xlab("10 social categories of school") +
  ylab("Lang Performance in Cohen's D at T3")  +
  theme_light() +
  theme(panel.background = element_rect(size = 0.1, linetype = 'solid',
                                colour = "grey")) +
  theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'solid',
                                colour = "#CCCCCC")) +
  theme(panel.spacing = unit(2, "lines")) +
  theme(axis.line.x = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))

ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1C_",ANNEE_COHORTE,"_10Categ_Total_Lang_T3_CohenD.svg"), width = 9, height = 6, dpi = 150)
```


### Fig S2 : math reproductibility in 2019, 2020 and 2021

### Fig S3 : Pb solving and number line


###### Problem Solving x Age effect  T1 T2 T3

```{r echo=TRUE}

# Resoud_Pb T1 

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T1_Resoud_Pb, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  coord_cartesian(ylim=c(-0.85,0.75)) +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  xlab("Age in first grade (month)") +
  ylab("Resoud_Pb level at T1 (Cohen's D)") +
  geom_hline(yintercept = 0, alpha = 0.2) +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))



ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Resoud_Pb_T1_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)

# Resoud_Pb T2

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T2_Resoud_Pb, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  coord_cartesian(ylim=c(-0.85,0.75)) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  xlab("Age in first grade (month)") +
  ylab("Resoud_Pb level at T2 (Cohen's D)") +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))


ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Resoud_Pb_T2_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)

# Resoud_Pb T3

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T3_Resoud_Pb, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  coord_cartesian(ylim=c(-0.85,0.75)) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  xlab("Age in first grade (month)") +
  ylab("Resoud_Pb level at T3 (Cohen's D)") +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))


ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Resoud_Pb_T3_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)

```

###### Number line x Age effect  T1 T2 T3

```{r echo=TRUE}

# Ligne_Num T1 

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T1_Ligne_Num, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  coord_cartesian(ylim=c(-0.70, 0.70)) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  xlab("Age in first grade (month)") +
  ylab("Ligne_Num level at T1 (Cohen's D)") +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))



ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Ligne_Num_T1_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)

# Ligne_Num T2

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T2_Ligne_Num, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  coord_cartesian(ylim=c(-0.70, 0.70)) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  xlab("Age in first grade (month)") +
  ylab("Ligne_Num level at T2 (Cohen's D)") +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))


ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Ligne_Num_T2_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)

# Ligne_Num T3

DATA_AGE %>%
  group_by(Age_CAT) %>%
  ggplot(mapping = aes(x = Age_T1, y = T3_Ligne_Num, group = Age_CAT, color = Age_CAT)) +
  stat_summary(fun="mean", size = 4, geom = "point") +
  scale_color_manual(values=c("limegreen", "dodgerblue" , "darkblue" )) +
  coord_cartesian(ylim=c(-0.70, 0.70)) +
  geom_hline(yintercept = 0, alpha = 0.2) +
  xlab("Age in first grade (month)") +
  ylab("Ligne_Num level at T3 (Cohen's D)") +
  theme_light() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1))


ggsave(paste0("~/img/",ANNEE_COHORTE,"/Graph_1B_Age_Effect_Ligne_Num_T3_", ANNEE_COHORTE,"_CohenD.svg"),
       width = 9, height = 6)

```





###### Graph 2B Problem solving 10 categ

```{r}

DATA_AGE_gau_Base_n %>% 
  group_by(Categ_10c_CP, Sexe_Boys, Categ_Etab_CP) %>%
  summarise(T3 = mean(T3_Resoud_Pb), T1 = mean(T1_Resoud_Pb), T2 = mean(T2_Resoud_Pb)) %>%
  pivot_longer(cols =c("T1", "T2", "T3"), names_to = "Period", values_to = "Grade") %>%
  ggplot(aes(x = Categ_10c_CP, y = Grade, group = interaction(Categ_Etab_CP, Sexe_Boys), color = Sexe_Boys)) +
  geom_line() +
  geom_point(size = 2) +
  facet_wrap(~Period) +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) + 
  theme(axis.line.x = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  ylab("Problem solving level (zscore)") +
  xlab("10 social categories of schools") + 
  coord_cartesian(ylim=c(-0.75,0.55)) + 
  geom_hline(yintercept = 0, alpha = 0.2) +
  scale_color_manual(values=c("#000066", "#FF3333"))

ggsave(paste0("~/img/", ANNEE_COHORTE, "/Graph_2B_", ANNEE_COHORTE, "_average_level_anova_Resoud_Pb_P_10c_CohenD.svg"), width = 9, height = 6)

```

###### Graph 2B Number line 10 categ


```{r}

DATA_AGE_gau_Base_n %>% 
  group_by(Categ_10c_CP, Sexe_Boys, Categ_Etab_CP) %>%
  summarise(T3 = mean(T3_Ligne_Num), T1 = mean(T1_Ligne_Num), T2 = mean(T2_Ligne_Num)) %>%
  pivot_longer(cols =c("T1", "T2", "T3"), names_to = "Period", values_to = "Grade") %>%
  ggplot(aes(x = Categ_10c_CP, y = Grade, group = interaction(Categ_Etab_CP, Sexe_Boys), color = Sexe_Boys)) +
  geom_line() +
  geom_point(size = 2) +
  facet_wrap(~Period) +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) + 
  theme(axis.line.x = element_line(arrow = arrow(length = unit(2, "mm")))) +
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  ylab("Number line level (zscore)") +
  xlab("10 social categories of schools") + 
  coord_cartesian(ylim=c(-0.60,0.40)) + 
  geom_hline(yintercept = 0, alpha = 0.2) +
  scale_color_manual(values=c("#000066", "#FF3333"))

ggsave(paste0("~/img/", ANNEE_COHORTE, "/Graph_2B_", ANNEE_COHORTE, "_average_level_anova_Ligne_Num_10c_CohenD.svg"), width = 9, height = 6)

```


##### 3B Number line - DATA_AGE_gau_Base_n

```{r}

# Data T1


DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T1", "Sexe_Boys", "T1_Ligne_Num")] 

DATA_Cohen$Age_T1 <- as.character(DATA_Cohen$Age_T1)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C5 <- DATA_Cohen %>%
  group_by(Age_T1) %>%
  cohens_d(T1_Ligne_Num ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C5)[1] <- "Time"
DATA_T1 <- DATA_C5[, c("Age_T1", "effsize", "Time")]

rm(DATA_C5, DATA_Cohen)

# Data T2

DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T2", "Sexe_Boys", "T2_Ligne_Num")]

DATA_Cohen$Age_T2 <- as.character(DATA_Cohen$Age_T2)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(Age_T2) %>%
  cohens_d(T2_Ligne_Num ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C6)[1] <- "Time"

DATA_T2 <- DATA_C6[, c("Age_T2", "effsize", "Time")]

rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T3", "Sexe_Boys", "T3_Ligne_Num")]

DATA_Cohen$Age_T3 <- as.character(DATA_Cohen$Age_T3)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(Age_T3) %>%
  cohens_d(T3_Ligne_Num ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"

DATA_T3 <- DATA_C7[, c("Age_T3", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "Age"
colnames(DATA_T2)[1] <- "Age"
colnames(DATA_T3)[1] <- "Age"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)

rm(DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$Age     <- as.numeric(DATA30_Cohen$Age)


legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Age, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D number line") +
  xlab("Age when taking the test (month)") +
  coord_cartesian(ylim=c(-0.066,0.28)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 


ggsave(file = paste0("~/img/", ANNEE_COHORTE, "/Graph_3A_DATA_AGE_gau_Base_n_Age_NumberLine_Cohen30_n_", ANNEE_COHORTE, "common_scale.svg"), width = 7, height = 5)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Age, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D number line") +
  xlab("Age when taking the test (month)") +
  coord_cartesian(ylim=c(0,0.28)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 


ggsave(file = paste0("~/img/", ANNEE_COHORTE, "/Graph_3A_DATA_AGE_gau_Base_n_Age_Numberline_Cohen30_n_", ANNEE_COHORTE, "adapted_scale.svg"), width = 7, height = 5)




```

##### 3B Problem solving - DATA_AGE_gau_Base_n

```{r}

# Data T1

DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T1", "Sexe_Boys", "T1_Resoud_Pb")] 

DATA_Cohen$Age_T1 <- as.character(DATA_Cohen$Age_T1)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C5 <- DATA_Cohen %>%
  group_by(Age_T1) %>%
  cohens_d(T1_Resoud_Pb ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C5)[1] <- "Time"

DATA_T1 <- DATA_C5[, c("Age_T1", "effsize", "Time")]

rm(DATA_C5, DATA_Cohen)

# Data T2

DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T2", "Sexe_Boys", "T2_Resoud_Pb")]

DATA_Cohen$Age_T2 <- as.character(DATA_Cohen$Age_T2)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(Age_T2) %>%
  cohens_d(T2_Resoud_Pb ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C6)[1] <- "Time"

DATA_T2 <- DATA_C6[, c("Age_T2", "effsize", "Time")]

rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- DATA_AGE_gau_Base_n[ , c("Age_T3", "Sexe_Boys", "T3_Resoud_Pb")]

DATA_Cohen$Age_T3 <- as.character(DATA_Cohen$Age_T3)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(Age_T3) %>%
  cohens_d(T3_Resoud_Pb ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"

DATA_T3 <- DATA_C7[, c("Age_T3", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "Age"
colnames(DATA_T2)[1] <- "Age"
colnames(DATA_T3)[1] <- "Age"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)

rm(DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$Age     <- as.numeric(DATA30_Cohen$Age)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Age, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D Problem solving") +
  xlab("Age when taking the test (month)") +
  coord_cartesian(ylim=c(-0.066,0.28)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 


ggsave(file = paste0("~/img/", ANNEE_COHORTE, "/Graph_3A_DATA_AGE_gau_Base_n_Age_PbSolving_Cohen30_n_", ANNEE_COHORTE, "common_scale.svg"), width = 7, height = 5)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Age, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D problem solving") +
  xlab("Age when taking the test (month)") +
  coord_cartesian(ylim=c(-0.066,0.17)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 


ggsave(file = paste0("~/img/", ANNEE_COHORTE, "/Graph_3A_DATA_AGE_gau_Base_n_Age_ProblemSolving_Cohen30_n_", ANNEE_COHORTE, "adapted_scale.svg"), width = 7, height = 5)



```

### Fig S4

##### Fig S4-A density on z-scores

```{r}
knitr::opts_chunk$set(echo = TRUE, include = TRUE)


# Consider DATA from SCRIPT #7 with Gaussianized data and selection of children of typical age and classes with 30% of boys and girls minimum per class = DATA_AGE_gau_Base_30n

load(paste0("~/Data/cohort_", ANNEE_COHORTE, "_", IMPUTED, "_ModRegLin_Gau_From_joined_V14112023.RData"))


# from Data Gaussianized in 30n : we want the data frame per class

DATA_AGE_gau_Base_30n <- DATA_AGE_gau_Base_30n[, c("ID_etab_class", "Categ_Etab_CP", "Taille_Classe", "IPS_Etab_CP",
                                                   "T1_Math", "T2_Math", "T3_Math", "Sexe_Boys")]


classes_gau <- DATA_AGE_gau_Base_30n[, c("ID_etab_class", "Categ_Etab_CP", "Taille_Classe", "IPS_Etab_CP")] %>%
  group_by(ID_etab_class, Categ_Etab_CP, Taille_Classe)
classes_gau <- unique(classes_gau)

# we want to calculate the mean of girls and boys in math per class on gaussianized data

synthetic_grades <- c("T1_Math", "T2_Math", "T3_Math")

DATA_AGE_gau_Base_30n$T1_Math <- as.numeric(DATA_AGE_gau_Base_30n$T1_Math)
DATA_AGE_gau_Base_30n$T2_Math <- as.numeric(DATA_AGE_gau_Base_30n$T2_Math)
DATA_AGE_gau_Base_30n$T3_Math <- as.numeric(DATA_AGE_gau_Base_30n$T3_Math)

for (grade in synthetic_grades){
  for (gender in c("Boys", "Girls")){
    temp <- DATA_AGE_gau_Base_30n[DATA_AGE_gau_Base_30n$Sexe_Boys == gender, c("ID_etab_class", grade)] %>%
      group_by(ID_etab_class) %>%
      summarise(mean = mean(!!as.name(grade)))

  # Name it accordingly
  names(temp)[names(temp) == "mean"] <- paste0("mean_", grade, "_", gender)

  # create column
  classes_gau <- merge(temp, classes_gau, by = "ID_etab_class", all.y = T)
  }
}

rm(temp)


# Create the gender difference per class

synthetic_grades <- c("T1_Math", "T2_Math", "T3_Math")

for (grade in synthetic_grades){
  
  classes_gau[, paste0("D_", grade)] <- classes_gau[, paste0("mean_", grade, "_Boys")] - classes_gau[, paste0("mean_", grade, "_Girls")]
    
}

rm(synthetic_grades)



# Plot the results for math


data_for_plot <- classes_gau[, c( "D_T3_Math", "D_T2_Math", "D_T1_Math")]
data_for_plot <- pivot_longer(data_for_plot, cols = c("D_T1_Math", "D_T2_Math", "D_T3_Math"), names_to = "Period", values_to = "Grade")

data_for_plot$Period <- substr(data_for_plot$Period , 3, 4)

ggplot(data_for_plot, aes(x = Grade, fill = Period, group = Period)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual (values = c("#CC6633", "#993333", "#FF3333"),
                     labels = c( "T1", "T2", "T3")) +
  geom_vline(xintercept = 0, col = "black") +
  coord_cartesian(xlim=c(-4,4)) +
  theme_minimal() +
  xlab("Gender gap in math (z-score)") +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) + 
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=8, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=8, color="black", angle=0, hjust = 1))
  

ggsave(file = paste0("~/", ANNEE_COHORTE, "_Graph_2D_Density_D_Math_zscore.svg"),
       width = 9, height = 5)

rm(data_for_plot)

```




##### Fig S4-B Class parameters

##### Fig S4-B Gender gap x class size

```{r}

# Data T1

DATA_Cohen <- joined_base_gaussian_3[ , c("Taille_Classe_D", "Sexe_Boys", "T1_Math")]


# Data T1

DATA_C5 <- DATA_Cohen %>%
  group_by(Taille_Classe_D) %>%
  cohens_d(T1_Math ~ Sexe_Boys, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1 <- DATA_C5[, c("Taille_Classe_D", "effsize", "Time")]

# Data T2
colnames(joined_base_gaussian_3)
DATA_Cohen <- joined_base_gaussian_3[ , c("Taille_Classe_D", "Sexe_Boys", "T2_Math")]
DATA_Cohen$Taille_Classe_D <- as.character(DATA_Cohen$Taille_Classe_D)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(Taille_Classe_D) %>%
  cohens_d(T2_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C6)[1] <- "Time"
DATA_T2 <- DATA_C6[, c("Taille_Classe_D", "effsize", "Time")]
rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- joined_base_gaussian_3[ , c("Taille_Classe_D", "Sexe_Boys", "T3_Math")]
DATA_Cohen$Taille_Classe_D <- as.character(DATA_Cohen$Taille_Classe_D)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(Taille_Classe_D) %>%
  cohens_d(T3_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"
DATA_T3 <- DATA_C7[, c("Taille_Classe_D", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "ClassSize"
colnames(DATA_T2)[1] <- "ClassSize"
colnames(DATA_T3)[1] <- "ClassSize"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)


rm( DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$ClassSize     <- as.numeric(DATA30_Cohen$ClassSize)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = ClassSize, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Class size in decile") +
  # coord_cartesian(ylim=c(-0.014,0.26)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

ggsave(file = paste0("~/img/Graph_4_", ANNEE_COHORTE, "_DataGau30_n_ClassSize_MATH_", ANNEE_COHORTE, "_adapted_scale.svg"), width = 7, height = 5)


legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = ClassSize, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Class size in decile") +
  coord_cartesian(ylim=c(-0.06,0.35)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

ggsave(file = paste0("~/img/Graph_4_", ANNEE_COHORTE, "_DataGau30_n_ClassSize_MATH_", ANNEE_COHORTE, "_common_scale.svg"), width = 7, height = 5)



```


##### Fig S4-B Gender gap x class level in math at T1 = T1_Math_class_D

```{r}
# Data T1

DATA_Cohen <- joined_base_gaussian_3[ , c("T1_Math_class_D", "Sexe_Boys", "T1_Math")]


# Data T1

DATA_C5 <- DATA_Cohen %>%
  group_by(T1_Math_class_D) %>%
  cohens_d(T1_Math ~ Sexe_Boys, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1 <- DATA_C5[, c("T1_Math_class_D", "effsize", "Time")]

# Data T2
colnames(joined_base_gaussian_3)
DATA_Cohen <- joined_base_gaussian_3[ , c("T1_Math_class_D", "Sexe_Boys", "T2_Math")]
DATA_Cohen$T1_Math_class_D <- as.character(DATA_Cohen$T1_Math_class_D)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(T1_Math_class_D) %>%
  cohens_d(T2_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C6)[1] <- "Time"
DATA_T2 <- DATA_C6[, c("T1_Math_class_D", "effsize", "Time")]
rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- joined_base_gaussian_3[ , c("T1_Math_class_D", "Sexe_Boys", "T3_Math")]
DATA_Cohen$T1_Math_class_D <- as.character(DATA_Cohen$T1_Math_class_D)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(T1_Math_class_D) %>%
  cohens_d(T3_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"
DATA_T3 <- DATA_C7[, c("T1_Math_class_D", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "ClassMath"
colnames(DATA_T2)[1] <- "ClassMath"
colnames(DATA_T3)[1] <- "ClassMath"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)


rm( DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$ClassMath     <- as.numeric(DATA30_Cohen$ClassMath)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = ClassMath, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Class Math in decile") +
  # coord_cartesian(ylim=c(-0.014,0.26)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

ggsave(file = paste0("~/img/Graph_4_", ANNEE_COHORTE, "_DataGau30_n_ClassMathT1_MATH_", ANNEE_COHORTE, "_adapted_scale.svg"), width = 7, height = 5)


legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = ClassMath, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Class Math in decile") +
  coord_cartesian(ylim=c(-0.06,0.35)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

ggsave(file = paste0("~/img/Graph_4_", ANNEE_COHORTE, "_DataGau30_n_ClassMathT1_MATH_", ANNEE_COHORTE, "_common_scale.svg"), width = 7, height = 5)




```


##### Fig S4-B Gender gap x heterogeneity in math at T1

```{r}

# Data T1

DATA_Cohen <- joined_base_gaussian_3[ , c("heterogeneity_T1_Math_D", "Sexe_Boys", "T1_Math")]


# Data T1

DATA_C5 <- DATA_Cohen %>%
  group_by(heterogeneity_T1_Math_D) %>%
  cohens_d(T1_Math ~ Sexe_Boys, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1 <- DATA_C5[, c("heterogeneity_T1_Math_D", "effsize", "Time")]

# Data T2
colnames(joined_base_gaussian_3)
DATA_Cohen <- joined_base_gaussian_3[ , c("heterogeneity_T1_Math_D", "Sexe_Boys", "T2_Math")]
DATA_Cohen$heterogeneity_T1_Math_D <- as.character(DATA_Cohen$heterogeneity_T1_Math_D)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(heterogeneity_T1_Math_D) %>%
  cohens_d(T2_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C6)[1] <- "Time"
DATA_T2 <- DATA_C6[, c("heterogeneity_T1_Math_D", "effsize", "Time")]
rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- joined_base_gaussian_3[ , c("heterogeneity_T1_Math_D", "Sexe_Boys", "T3_Math")]
DATA_Cohen$heterogeneity_T1_Math_D <- as.character(DATA_Cohen$heterogeneity_T1_Math_D)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(heterogeneity_T1_Math_D) %>%
  cohens_d(T3_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"
DATA_T3 <- DATA_C7[, c("heterogeneity_T1_Math_D", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "Hetero"
colnames(DATA_T2)[1] <- "Hetero"
colnames(DATA_T3)[1] <- "Hetero"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)


rm( DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$Hetero     <- as.numeric(DATA30_Cohen$Hetero)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Hetero, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Hetero in decile") +
  # coord_cartesian(ylim=c(-0.014,0.26)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

ggsave(file = paste0("~/img/Graph_4_", ANNEE_COHORTE, "_DataGau30_n_Hetero_MATH_", ANNEE_COHORTE, "_adapted_scale.svg"), width = 7, height = 5)


legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Hetero, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Hetero in decile") +
  coord_cartesian(ylim=c(-0.06,0.35)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

ggsave(file = paste0("~/img/Graph_4_", ANNEE_COHORTE, "_DataGau30_n_Hetero_MATH_", ANNEE_COHORTE, "_common_scale.svg"), width = 7, height = 5)




```

##### Fig S4-B Gender gap x boys girls ratio boy_prop_D

```{r}

# Data T1

DATA_Cohen <- joined_base_gaussian_3[ , c("boy_prop_D", "Sexe_Boys", "T1_Math")]


# Data T1

DATA_C5 <- DATA_Cohen %>%
  group_by(boy_prop_D) %>%
  cohens_d(T1_Math ~ Sexe_Boys, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1 <- DATA_C5[, c("boy_prop_D", "effsize", "Time")]

# Data T2
colnames(joined_base_gaussian_3)
DATA_Cohen <- joined_base_gaussian_3[ , c("boy_prop_D", "Sexe_Boys", "T2_Math")]
DATA_Cohen$boy_prop_D <- as.character(DATA_Cohen$boy_prop_D)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(boy_prop_D) %>%
  cohens_d(T2_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C6)[1] <- "Time"
DATA_T2 <- DATA_C6[, c("boy_prop_D", "effsize", "Time")]
rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- joined_base_gaussian_3[ , c("boy_prop_D", "Sexe_Boys", "T3_Math")]
DATA_Cohen$boy_prop_D <- as.character(DATA_Cohen$boy_prop_D)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(boy_prop_D) %>%
  cohens_d(T3_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"
DATA_T3 <- DATA_C7[, c("boy_prop_D", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "Ratio"
colnames(DATA_T2)[1] <- "Ratio"
colnames(DATA_T3)[1] <- "Ratio"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)


rm( DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$Ratio     <- as.numeric(DATA30_Cohen$Ratio)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Ratio, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Ratio in decile") +
  # coord_cartesian(ylim=c(-0.014,0.26)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

ggsave(file = paste0("~/img/Graph_4_", ANNEE_COHORTE, "_DataGau30_n_Ratio_MATH_", ANNEE_COHORTE, "_adapted_scale.svg"), width = 7, height = 5)


legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Ratio, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Ratio in decile") +
  coord_cartesian(ylim=c(-0.06,0.35)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

ggsave(file = paste0("~/img/Graph_4_", ANNEE_COHORTE, "_DataGau30_n_Ratio_MATH_", ANNEE_COHORTE, "_common_scale.svg"), width = 7, height = 5)


```


##### Fig S4-C First of class

Effect of 1st of class in math at T1 : Regarding if the role model in math or language was a girl or a boy, had a significant association with a gender gap variation.

First of class Math WITHOUT 1st of class on gaussianized data, typical age and classes with minimum 30% of boys and girls per class


```{r}

##### identifying and tagging if boys or girls or mixed are first of class

Joined_Fin_3$What_first <- case_when(Joined_Fin_3$First_sexe_in_T1_Math > 0 ~ "Boys",
                                 Joined_Fin_3$First_sexe_in_T1_Math < 0 ~ "Girls",
                                 Joined_Fin_3$First_sexe_in_T1_Math == 0 ~ "Mixed")
Joined_Fin_3$What_first <- as.factor(Joined_Fin_3$What_first)
summary(Joined_Fin_3$What_first)

DATA_int <- Joined_Fin_3[Joined_Fin_3$first_in_T1_Math == FALSE , ]

DATA_Boys   <- DATA_int[DATA_int$What_first == "Boys" , ]
DATA_Girls  <- DATA_int[DATA_int$What_first == "Girls" , ]
DATA_Mixed  <- DATA_int[DATA_int$What_first == "Mixed" , ]

sum(is.na(DATA_int$What_first)) # 0 NA



### 3A Math Data common (boys first + girls first )


# Data T1


DATA_Cohen <- DATA_int[ , c("Age_T1", "Sexe_Boys", "T1_Math")]

DATA_Cohen$Age_T1  <- as.character(DATA_Cohen$Age_T1)
DATA_Cohen$Sexe_Boys    <- as.character(DATA_Cohen$Sexe_Boys)
DATA_Cohen$T1_Math <- as.numeric(DATA_Cohen$T1_Math)

DATA_C5 <- DATA_Cohen %>%
  group_by(Age_T1) %>%
  cohens_d(T1_Math ~ Sexe_Boys, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1 <- DATA_C5[, c("Age_T1", "effsize", "Time")]

# Data T2

DATA_Cohen <- DATA_int[ , c("Age_T2", "Sexe_Boys", "T2_Math")]
DATA_Cohen$Age_T2 <- as.character(DATA_Cohen$Age_T2)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(Age_T2) %>%
  cohens_d(T2_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C6)[1] <- "Time"
DATA_T2 <- DATA_C6[, c("Age_T2", "effsize", "Time")]
rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- DATA_int[ , c("Age_T3", "Sexe_Boys", "T3_Math")]
DATA_Cohen$Age_T3 <- as.character(DATA_Cohen$Age_T3)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(Age_T3) %>%
  cohens_d(T3_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"
DATA_T3 <- DATA_C7[, c("Age_T3", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "Age"
colnames(DATA_T2)[1] <- "Age"
colnames(DATA_T3)[1] <- "Age"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)


rm( DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$Age     <- as.numeric(DATA30_Cohen$Age)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Age, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Age when taking the test (month)") +
  coord_cartesian(ylim=c(-0.5,0.5)) +
  # coord_cartesian(ylim=c(-0.05,0.28)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

# ggsave(file = paste0(~/Data/img/", ANNEE_COHORTE, "/Graph_3A_DataGau_n_Age_MATH_Cohen30_n_", ANNEE_COHORTE, "_adapted_scale.svg"), width = 7, height = 5)


```

##### Fig S4-C on Data_BOYS

```{r}

### 3A Math Data GAU 30n 


# Data T1


DATA_Cohen <- DATA_Boys[ , c("Age_T1", "Sexe_Boys", "T1_Math")]

DATA_Cohen$Age_T1  <- as.character(DATA_Cohen$Age_T1)
DATA_Cohen$Sexe_Boys    <- as.character(DATA_Cohen$Sexe_Boys)
DATA_Cohen$T1_Math <- as.numeric(DATA_Cohen$T1_Math)

DATA_C5 <- DATA_Cohen %>%
  group_by(Age_T1) %>%
  cohens_d(T1_Math ~ Sexe_Boys, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1 <- DATA_C5[, c("Age_T1", "effsize", "Time")]

# Data T2

DATA_Cohen <- DATA_Boys[ , c("Age_T2", "Sexe_Boys", "T2_Math")]
DATA_Cohen$Age_T2 <- as.character(DATA_Cohen$Age_T2)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(Age_T2) %>%
  cohens_d(T2_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C6)[1] <- "Time"
DATA_T2 <- DATA_C6[, c("Age_T2", "effsize", "Time")]
rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- DATA_Boys[ , c("Age_T3", "Sexe_Boys", "T3_Math")]
DATA_Cohen$Age_T3 <- as.character(DATA_Cohen$Age_T3)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(Age_T3) %>%
  cohens_d(T3_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"
DATA_T3 <- DATA_C7[, c("Age_T3", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "Age"
colnames(DATA_T2)[1] <- "Age"
colnames(DATA_T3)[1] <- "Age"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)


rm( DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$Age     <- as.numeric(DATA30_Cohen$Age)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Age, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Age when taking the test (month)") +
  coord_cartesian(ylim=c(-0.5,0.5)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

# ggsave(file = paste0(~/Data/img/", ANNEE_COHORTE, "/Graph_3A_DataGau_n_Age_MATH_Cohen30_n_", ANNEE_COHORTE, "_adapted_scale.svg"), width = 7, height = 5)




```

##### Fig S4-C on Data Girls Data30n

```{r}

### 3A Math Data GAU 30n 


# Data T1


DATA_Cohen <- DATA_Girls[ , c("Age_T1", "Sexe_Boys", "T1_Math")]

DATA_Cohen$Age_T1  <- as.character(DATA_Cohen$Age_T1)
DATA_Cohen$Sexe_Boys    <- as.character(DATA_Cohen$Sexe_Boys)
DATA_Cohen$T1_Math <- as.numeric(DATA_Cohen$T1_Math)

DATA_C5 <- DATA_Cohen %>%
  group_by(Age_T1) %>%
  cohens_d(T1_Math ~ Sexe_Boys, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1 <- DATA_C5[, c("Age_T1", "effsize", "Time")]

# Data T2

DATA_Cohen <- DATA_Girls[ , c("Age_T2", "Sexe_Boys", "T2_Math")]
DATA_Cohen$Age_T2 <- as.character(DATA_Cohen$Age_T2)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(Age_T2) %>%
  cohens_d(T2_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C6)[1] <- "Time"
DATA_T2 <- DATA_C6[, c("Age_T2", "effsize", "Time")]
rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- DATA_Girls[ , c("Age_T3", "Sexe_Boys", "T3_Math")]
DATA_Cohen$Age_T3 <- as.character(DATA_Cohen$Age_T3)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(Age_T3) %>%
  cohens_d(T3_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"
DATA_T3 <- DATA_C7[, c("Age_T3", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "Age"
colnames(DATA_T2)[1] <- "Age"
colnames(DATA_T3)[1] <- "Age"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)


rm( DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$Age     <- as.numeric(DATA30_Cohen$Age)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Age, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Age when taking the test (month)") +
  coord_cartesian(ylim=c(-0.5,0.5)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

# ggsave(file = paste0(~/Data/img/", ANNEE_COHORTE, "/Graph_3A_DataGau_n_Age_MATH_Cohen30_n_", ANNEE_COHORTE, "_adapted_scale.svg"), width = 7, height = 5)




```

##### Fig S4-C Mixed on Data_30n

```{r}

### 3A Math Data GAU 30n 


# Data T1


DATA_Cohen <- DATA_Mixed[ , c("Age_T1", "Sexe_Boys", "T1_Math")]

DATA_Cohen$Age_T1  <- as.character(DATA_Cohen$Age_T1)
DATA_Cohen$Sexe_Boys    <- as.character(DATA_Cohen$Sexe_Boys)
DATA_Cohen$T1_Math <- as.numeric(DATA_Cohen$T1_Math)

DATA_C5 <- DATA_Cohen %>%
  group_by(Age_T1) %>%
  cohens_d(T1_Math ~ Sexe_Boys, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1 <- DATA_C5[, c("Age_T1", "effsize", "Time")]

# Data T2

DATA_Cohen <- DATA_Mixed[ , c("Age_T2", "Sexe_Boys", "T2_Math")]
DATA_Cohen$Age_T2 <- as.character(DATA_Cohen$Age_T2)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C6 <- DATA_Cohen %>%
  group_by(Age_T2) %>%
  cohens_d(T2_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C6)[1] <- "Time"
DATA_T2 <- DATA_C6[, c("Age_T2", "effsize", "Time")]
rm(DATA_C6, DATA_Cohen)

# Data T3

DATA_Cohen <- DATA_Mixed[ , c("Age_T3", "Sexe_Boys", "T3_Math")]
DATA_Cohen$Age_T3 <- as.character(DATA_Cohen$Age_T3)
DATA_Cohen$Sexe_Boys <- as.character(DATA_Cohen$Sexe_Boys)

DATA_C7 <- DATA_Cohen %>%
  group_by(Age_T3) %>%
  cohens_d(T3_Math ~ Sexe_Boys, var.equal = FALSE)
colnames(DATA_C7)[1] <- "Time"
DATA_T3 <- DATA_C7[, c("Age_T3", "effsize", "Time")]

rm(DATA_C7, DATA_Cohen)

# Rassembler les Data T1, T2, T3

colnames(DATA_T1)[1] <- "Age"
colnames(DATA_T2)[1] <- "Age"
colnames(DATA_T3)[1] <- "Age"

DATA30_Cohen <- rbind(DATA_T1, DATA_T2, DATA_T3)


rm( DATA_T1, DATA_T2, DATA_T3)

DATA30_Cohen$effsize <- as.numeric(DATA30_Cohen$effsize)
DATA30_Cohen$Age     <- as.numeric(DATA30_Cohen$Age)

legend_title <- "Time"
ggplot(data = DATA30_Cohen, aes(x = Age, y = effsize, color = Time)) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, col = "black") +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) +  
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  ylab("Cohen's D math (Percentage gaussianized)") +
  xlab("Age when taking the test (month)") +
  coord_cartesian(ylim=c(-0.5,0.5)) +
  scale_color_manual(legend_title, values=c("deepskyblue", "blue2","midnightblue")) 

# ggsave(file = paste0(~/Data/img/", ANNEE_COHORTE, "/Graph_3A_DataGau_n_Age_MATH_Cohen30_n_", ANNEE_COHORTE, "_adapted_scale.svg"), width = 7, height = 5)




```


### Fig S5

###### Language 10 categ

```{r}


knitr::opts_chunk$set(echo = TRUE, include = TRUE)

library(tidyverse)
library(dplyr)
library(rmarkdown)
library(ggplot2)
library(reshape2)
library(alluvial)
library(patchwork)
library(ciTools)
library(gmodels)

load(paste0("~/Data/cohort_", ANNEE_COHORTE, "_", IMPUTED, "_ModRegLin_Gau_From_joined.RData"))

DATA_AGE_gau_Base_n %>% 
  group_by(Categ_10c_CP, Sexe_Boys, Categ_Etab_CP) %>%
  summarise(T3 = mean(T3_Language), T1 = mean(T1_Language), T2 = mean(T2_Language)) %>%
  pivot_longer(cols =c("T1", "T2", "T3"), names_to = "Period", values_to = "Grade") %>%
  ggplot(aes(x = Categ_10c_CP, y = Grade, group = interaction(Categ_Etab_CP, Sexe_Boys), color = Sexe_Boys)) +
  geom_line() +
  geom_point(size = 2) +
  facet_wrap(~Period) +
  theme_minimal() +
  theme(axis.line.y = element_line(arrow = arrow(length = unit(2, "mm")))) + 
  theme(axis.title.x = element_text(size=12,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=12, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=12, color="black", angle=0, hjust = 1)) +
  ylab("Language level (zscore)") +
  xlab("10 social categories of schools") + 
  coord_cartesian(ylim=c(-0.8,0.5)) + 
  geom_hline(yintercept = 0, alpha = 0.2) +
  scale_color_manual(values=c("#000066", "#FF3333"))
ggsave(paste0("~/img/", ANNEE_COHORTE, "/Graph_2A_", ANNEE_COHORTE, "_average_level_anova_LANG_10c_CohenD.svg"), width = 9, height = 6)

```

###### Language Ranks

```{r echo=TRUE}

load(file = paste0("~/Data/cohort_", ANNEE_COHORTE, "_imputed_joined_n.RData"))


joined2 <- joined_n[, c("ID_etab_class",  "Sexe", "T1_Math", "T1_Math_Rank",
                        "T2_Math_Rank", "T3_Math_Rank",
                        "D_T1_Math", "D_T1_Math_Rank", "D_T2_Math", "D_T2_Math_Rank",
                        "D_T3_Math", "D_T3_Math_Rank", 
                        "T1_Language", "T3_Lang_Rank", "T2_Lang_Rank", "T1_Lang_Rank", 
                        "D_T1_Language", "D_T1_Lang_Rank", "D_T2_Language", "D_T2_Lang_Rank",
                        "D_T3_Language", "D_T3_Lang_Rank" )]

glimpse(joined2)

names(joined2)[names(joined2) == "Sexe"] <- "Sexe_Boys" 
joined2$Sexe_Boys <- as.factor(joined2$Sexe_Boys)
summary(joined2$Sexe_Boys)

data_for_plot <- joined2[, c("T3_Lang_Rank", "T2_Lang_Rank", "T1_Lang_Rank", "Sexe_Boys")]

data_for_plot <- pivot_longer(data_for_plot, cols = c("T1_Lang_Rank", "T2_Lang_Rank", "T3_Lang_Rank"), names_to = "Period", values_to = "Grade")
data_for_plot$Period <- substr(data_for_plot$Period , 1, 2)


ggplot(data_for_plot, aes(x = Grade*100, fill = Sexe_Boys, group = Sexe_Boys)) +
  facet_wrap(~ Period, ncol = 3) +
  geom_histogram(position = "identity", alpha = 0.6,
                 binwidth = 2.5 ,
                 breaks=seq(0, 100, by = 4)) +
  scale_fill_manual (values = c("#000066", "#FF3333"), labels = c( "Boys", "Girls")) +
  xlab("Language level (Percentile rank)") +
  theme_minimal() +
  theme(axis.line = element_line(arrow = arrow(length = unit(2, "mm")))) + 
  theme(axis.title.x = element_text(size=9,  color="black", angle=0, hjust = 1)) +
  theme(axis.title.y = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.x = element_text(size=9, color="black", angle=0, hjust = 1)) +
  theme(axis.text.y = element_text(size=9, color="black", angle=0, hjust = 1))
  


ggsave(file = paste0("~/img/", ANNEE_COHORTE, "/Graph_2C_distribution_Lang_", ANNEE_COHORTE, "_CohenD.svg"), width = 9, height = 3)

rm(data_for_plot)

```
