---
title: "Data Management of DEPP cohort Evalaide - Data exploration"
author:
  - Pauline Martinot [UNICOG, NeuroSpin]
  - Bénédicte Colnet [Inria, Paris-Saclay]
date: "July 2021"
output:
  html_document:
    number_sections: no
    toc: yes
    toc_depth: 2
  pdf_document:
    toc: yes
abstract: | 
  This notebook concerns data from National assessment in 1st and 2nd grade in France : Data exploration.
---

# Parameters

```{r}
knitr::opts_chunk$set(echo = TRUE)

# Parameters to set before launch of the pipeline
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2018" 

# Library

library(ggplot2)
library(FactoMineR)
library(dplyr)
library(tidyverse)

library(broom)
library(jtools)
library(boot)
library(tidyr)
library(table1)
library(htmlTable)
library(knitr)
library(reshape2)
library(tableone)

library(fastmap)

```

# Table S3 : Data for Sensitivity analysis

##### data_depp_non_imp_1

classes 6 to 27 per class

- imputed                     # n 2018 = 586,949
- non imputed naomit = false  # n 2018 = 586,949
- non imputed naomit = true   # n 2018 = 468,883

Pb solved : 

- we need the data_depp_non_imp_1 from SCRIPT 1 that stopped at line 677.
After this line, we produce more NA as we transform 0 and whole lines of 0 with NA.


##### Cohorte 2018 - Parameters

```{r include=FALSE}

# Parameters 
ANNEE_COHORTE = 2018
#  2018 2019 2020 2021

# Age in month (with limits to detect outliers)
AGE_PRECOCE    = 69   # parameter used to classify a child being in advance, but not an outlier
AGE_NORMAL_MOY = 74   # helps to define subcategories for age
AGE_RETARD     = 80   # parameter used to classify a child being late, but not an outlier
AGE_MIN        = 51   # all children with age below this age are considered outliers
AGE_MAX        = 98   # all children with age above this age are considered outliers
AGE_NORM_BAS   = 57   # all children with age between this and AGE_PRECOCE are considered 1 year in advance
AGE_NORM_SUP   = 92   # all children with age between this and AGE_RETARD are considered 1 year late

PATH_IMAGE = "~/img/" # where to store output

# threshold on class size
SEUIL_INF_CLASS = 5    # as calculating heterogeneity and mixity in very small classes might be confusing
SEUIL_SUP_CLASS = 28   # all classes above are considered outliers
SEUIL_TAILLE    = 13   # Political measure on small classe put the threshold at 12 

TEST = FALSE # TRUE if the notebook is currently being tested and want to run "fast" the pipeline

```

##### Load data

```{r include=FALSE}

if (ANNEE_COHORTE == 2018){
   data_depp_1 <- read.csv2("~/Desktop/education/data/data_depp_1819.csv", sep=';', header=TRUE) 
  } else if (ANNEE_COHORTE == 2019){
  data_depp_1 <- readRDS("~/Data/Evalaide_1920_DonneesChercheursDomaines.rds")
  } else if (ANNEE_COHORTE == 2020){
  data_depp_1 <- readRDS("~/Data/Evalaide_2021_Donnees_Domaines_chercheurs.rds")
  } else if (ANNEE_COHORTE == 2021){
  data_depp_1 <- readRDS("~/Data/CPCE1_Donnees_cohorte_2021_2022(1).rds")
  } else {
  print("Error in ANNEE_COHORTE or data location")
  }
if(TEST){
  data_depp_1 <- data_depp_1[1:10000,]
}
```


##### Libraries & Packages 

```{r setup package, include=FALSE, warning = FALSE, message = FALSE}
library(dplyr)
library(ggplot2)
library(naniar)
library(reshape2) 
library(UpSetR) # for upset plot (equivalence of Venn diagram)
library(mice) # imputation

knitr::opts_chunk$set(echo = TRUE, include = TRUE)
```


##### Detect empty raw if any, and warn.

```{r echo=FALSE}

# indicator of rows with only NA
ind <- apply(data_depp_1, 1, function(x) all(is.na(x)))
if (sum(ind) > 0){
  print("WARNING:")
  print(sum(ind))
  print(" rows contain only NA. They are deleted")
  data_depp_1 <- data_depp_1[!ind,]
} else {
  print("GOOD: No rows with only NAs.")
}

```

Note that the raw data contains `r nrow(data_depp_1)` children.

##### Check nature of the column

```{r include=FALSE}

sapply(data_depp_1, class)

if (ANNEE_COHORTE == 2018){
  
    data_depp_1$sexe              <- as.factor(as.character(data_depp_1$sexe))
    data_depp_1$strate_CP         <- as.factor(as.character(data_depp_1$strate_CP))
    data_depp_1$strate_CE1        <- as.factor(as.character(data_depp_1$strate_CE1))
    data_depp_1$IPS_CP            <- as.numeric(as.character(data_depp_1$IPS_CP))
    data_depp_1$IPS_CE1           <- as.numeric(as.character(data_depp_1$IPS_CE1))
    
  } else if (ANNEE_COHORTE == 2019){
    
    data_depp_1$sexe              <- as.factor(as.character(data_depp_1$sexe))
    data_depp_1$strate_CP         <- as.factor(as.character(data_depp_1$strate_CP))
    data_depp_1$strate_Mi         <- as.factor(as.character(data_depp_1$strate_Mi))
    data_depp_1$strate_CE1        <- as.factor(as.character(data_depp_1$strate_CE1))
    data_depp_1$ips_Debut         <- as.numeric(as.character(data_depp_1$ips_Debut))
    data_depp_1$ips_Mi            <- as.numeric(as.character(data_depp_1$ips_Mi))
    data_depp_1$ips_CE1           <- as.numeric(as.character(data_depp_1$ips_CE1))
    
  } else if (ANNEE_COHORTE == 2020){
    data_depp_1$sexe              <- as.factor(as.character(data_depp_1$sexe))
    data_depp_1$strate_CP         <- as.factor(as.character(data_depp_1$strate_CP))
    data_depp_1$strate_Mi         <- as.factor(as.character(data_depp_1$strate_Mi))
    data_depp_1$strate_CE1        <- as.factor(as.character(data_depp_1$strate_CE1))
    data_depp_1$ips_Debut         <- as.numeric(as.character(data_depp_1$ips_Debut))
    data_depp_1$ips_Mi            <- as.numeric(as.character(data_depp_1$ips_Mi))
    data_depp_1$ips_CE1           <- as.numeric(as.character(data_depp_1$ips_CE1))
  
  } else if (ANNEE_COHORTE == 2021){
    data_depp_1$sex               <- as.factor(as.character(data_depp_1$sex))
    data_depp_1$strate_cp         <- as.factor(as.character(data_depp_1$strate2_CP))
    data_depp_1$ips_cp            <- as.numeric(as.character(data_depp_1$ips_CP))
    
   
  }

sapply(data_depp_1, class)

```


##### Renaming variables

This part renames columns, and takes into account the fact that data come from three cohort comports different columns names and/or columns.

```{r echo=TRUE}

# Child and school characteristics

names(data_depp_1)[names(data_depp_1) == "sexe"]                 <- "Sexe"
names(data_depp_1)[names(data_depp_1) == "strate_CP"]            <- "Categ_Etab_CP"
names(data_depp_1)[names(data_depp_1) == "strate_cp"]            <- "Categ_Etab_CP"
names(data_depp_1)[names(data_depp_1) == "birthday"]             <- "Date_Naiss"
names(data_depp_1)[names(data_depp_1) == "CodeEleve"]            <- "ID_Eleve"
names(data_depp_1)[names(data_depp_1) == "CodeEtablissementCP"]  <- "ID_Etab_CP"
names(data_depp_1)[names(data_depp_1) == "CodeClasseCP"]         <- "ID_Classe_CP"
names(data_depp_1)[names(data_depp_1) == "ips_cp"]               <- "IPS_Etab_CP"
names(data_depp_1)[names(data_depp_1) == "IPS_CP"]               <- "IPS_Etab_CP"  # 2018
names(data_depp_1)[names(data_depp_1) == "ips_Debut"]            <- "IPS_Etab_CP"  # 2019 2020
names(data_depp_1)[names(data_depp_1) == "ips_CP"]               <- "IPS_Etab_CP"  # 2021

# Language - First Period

names(data_depp_1)[names(data_depp_1) == "CPFCOMO_Debut"] <- "T1_Comp_Mots"
names(data_depp_1)[names(data_depp_1) == "CPFCOPH_Debut"] <- "T1_Comp_Phra"
names(data_depp_1)[names(data_depp_1) == "CPFCOTE_Debut"] <- "T1_Comp_Text"
names(data_depp_1)[names(data_depp_1) == "CPFPHPH_Debut"] <- "T1_Manip_Phon"
names(data_depp_1)[names(data_depp_1) == "CPFPHSY_Debut"] <- "T1_Manip_Syll"
names(data_depp_1)[names(data_depp_1) == "CPFRLGP_Debut"] <- "T1_Conn_Lettres"
names(data_depp_1)[names(data_depp_1) == "CPFRLLE_Debut"] <- "T1_Recon_Ecritu_L"
names(data_depp_1)[names(data_depp_1) == "CPFRLSY_Debut"] <- "T1_Compa_Lettres"

# Math - First Period

names(data_depp_1)[names(data_depp_1) == "CPMETNOCOEN_Debut"] <- "T1_Ecri_Nombre"
names(data_depp_1)[names(data_depp_1) == "CPMETNOCORN_Debut"] <- "T1_Lire_Nombre"
names(data_depp_1)[names(data_depp_1) == "CPMETNOPR_Debut"]   <- "T1_Resoud_Pb"
names(data_depp_1)[names(data_depp_1) == "CPMUTNOCA_Debut"]   <- "T1_Denombrer"
names(data_depp_1)[names(data_depp_1) == "CPMUTNOGN_Debut"]   <- "T1_Compa_Nombre"
names(data_depp_1)[names(data_depp_1) == "CPMUTNOLN_Debut"]   <- "T1_Ligne_Num"


# Language - Second Period

names(data_depp_1)[names(data_depp_1) == "CPFCOPH_Mi"]       <- "T2_Comp_Phra"
names(data_depp_1)[names(data_depp_1) == "CPFLILVMO_Mi"]     <- "T2_Lire_Mots"
names(data_depp_1)[names(data_depp_1) == "CPFLILVTE_Mi"]     <- "T2_Lire_Text"
names(data_depp_1)[names(data_depp_1) == "CPFLOE_Mi"]        <- "T2_Ecri_Syll"
names(data_depp_1)[names(data_depp_1) == "CPFLOR_Mi"]        <- "T2_Ecri_Mots"
names(data_depp_1)[names(data_depp_1) == "CPFPHPH_Mi"]       <- "T2_Manip_Phon"
names(data_depp_1)[names(data_depp_1) == "CPFRLGP_Mi"]       <- "T2_Conn_Lettres"

if (ANNEE_COHORTE == 2019){
  names(data_depp_1)[names(data_depp_1) == "CPFLICP_Mi"]       <- "T2_Comp_Phra_Lu" # Nouvelle Var 2 : Max 8/8, comprendre les phrases lues seul

} else if (ANNEE_COHORTE == 2020){
  names(data_depp_1)[names(data_depp_1) == "CPFLICP_Mi"]       <- "T2_Comp_Phra_Lu"  # new variable in 2021
}


# Math - Second Period

names(data_depp_1)[names(data_depp_1) == "CPMNOCACOGN_Mi"]   <- "T2_Compa_Nombre"
names(data_depp_1)[names(data_depp_1) == "CPMNOCACOLN_Mi"]   <- "T2_Ligne_Num"
names(data_depp_1)[names(data_depp_1) == "CPMNOCANECLAD_Mi"] <- "T2_Addition"
names(data_depp_1)[names(data_depp_1) == "CPMNOCANECLSO_Mi"] <- "T2_Soustract"
names(data_depp_1)[names(data_depp_1) == "CPMNOCANOEN_Mi"]   <- "T2_Ecri_Nombre"
names(data_depp_1)[names(data_depp_1) == "CPMNOCARP_Mi"]     <- "T2_Resoud_Pb"


if (ANNEE_COHORTE == 2018){
  
  # Language - Third Period
  names(data_depp_1)[names(data_depp_1) == "CE1COMO"]        <- "T3_Comp_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1COPH"]        <- "T3_Comp_Phra"
  names(data_depp_1)[names(data_depp_1) == "CE1FLOE"]        <- "T3_Ecri_Syll"
  names(data_depp_1)[names(data_depp_1) == "CE1FLOR"]        <- "T3_Ecri_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1LICP"]        <- "T3_Comp_Phra_Lu"
  names(data_depp_1)[names(data_depp_1) == "CE1LICTEN"]      <- "T3_Comp_Text_Lu"
  names(data_depp_1)[names(data_depp_1) == "CE1LILVMO"]      <- "T3_Lire_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1LILVTE"]      <- "T3_Lire_Text"
  
  # Math - Third Period
  names(data_depp_1)[names(data_depp_1) == "CE1MEGAS"]       <- "T3_Assemblage"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCACOLN"]   <- "T3_Ligne_Num"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECLAD"] <- "T3_Addition"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECLSO"] <- "T3_Soustract"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECM"]   <- "T3_Calcul_Mental"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANOEN"]   <- "T3_Ecri_Nombre"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANORC"]   <- "T3_Lire_Nombre"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANORP"]   <- "T3_Repres_Nb"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCARP"]     <- "T3_Resoud_Pb"
  
} else if (ANNEE_COHORTE == 2019) {
  # Language - Third Period
  names(data_depp_1)[names(data_depp_1) == "CE1COMO_CE1"]            <- "T3_Comp_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1COPH_CE1"]            <- "T3_Comp_Phra"
  names(data_depp_1)[names(data_depp_1) == "CE1FLOE_CE1"]            <- "T3_Ecri_Syll"
  names(data_depp_1)[names(data_depp_1) == "CE1FLOR_CE1"]            <- "T3_Ecri_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1LICP_CE1"]            <- "T3_Comp_Phra_Lu"
  names(data_depp_1)[names(data_depp_1) == "CE1LICTEN_CE1"]          <- "T3_Comp_Text_Lu"
  names(data_depp_1)[names(data_depp_1) == "CE1LILVMO_CE1"]          <- "T3_Lire_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1LILVTE_CE1"]          <- "T3_Lire_Text"
  
  # Math - Third Period  
  names(data_depp_1)[names(data_depp_1) == "CE1MEGAS_CE1"]       <- "T3_Assemblage"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCACOLN_CE1"]   <- "T3_Ligne_Num"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECLAD_CE1"] <- "T3_Addition"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECLSO_CE1"] <- "T3_Soustract"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECM_CE1"]   <- "T3_Calcul_Mental"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANOEN_CE1"]   <- "T3_Ecri_Nombre"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANORC_CE1"]   <- "T3_Lire_Nombre"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANORP_CE1"]   <- "T3_Repres_Nb"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCARP_CE1"]     <- "T3_Resoud_Pb"
  
} else if (ANNEE_COHORTE == 2020) {
  # Language - Third Period
  names(data_depp_1)[names(data_depp_1) == "CE1COMO_CE1"]            <- "T3_Comp_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1COPH_CE1"]            <- "T3_Comp_Phra"
  names(data_depp_1)[names(data_depp_1) == "CE1FLOE_CE1"]            <- "T3_Ecri_Syll"
  names(data_depp_1)[names(data_depp_1) == "CE1FLOR_CE1"]            <- "T3_Ecri_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1LICP_CE1"]            <- "T3_Comp_Phra_Lu"
  names(data_depp_1)[names(data_depp_1) == "CE1LICTEN_CE1"]          <- "T3_Comp_Text_Lu"
  names(data_depp_1)[names(data_depp_1) == "CE1LILVMO_CE1"]          <- "T3_Lire_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1LILVTE_CE1"]          <- "T3_Lire_Text"
  
  # Math - Third Period  
  names(data_depp_1)[names(data_depp_1) == "CE1MEGAS_CE1"]       <- "T3_Assemblage"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCACOLN_CE1"]   <- "T3_Ligne_Num"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECLAD_CE1"] <- "T3_Addition"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECLSO_CE1"] <- "T3_Soustract"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECM_CE1"]   <- "T3_Calcul_Mental"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANOEN_CE1"]   <- "T3_Ecri_Nombre"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANORC_CE1"]   <- "T3_Lire_Nombre"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANORP_CE1"]   <- "T3_Repres_Nb"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCARP_CE1"]     <- "T3_Resoud_Pb"


} else if (ANNEE_COHORTE == 2021) {

# Child and school characteristics

names(data_depp_1)[names(data_depp_1) == "sex"]                  <- "Sexe"
names(data_depp_1)[names(data_depp_1) == "strate2_CP"]           <- "Categ_Etab_CP"
names(data_depp_1)[names(data_depp_1) == "birthday"]             <- "Date_Naiss"
names(data_depp_1)[names(data_depp_1) == "id_neutre_eleve"]      <- "ID_Eleve"
names(data_depp_1)[names(data_depp_1) == "id_neutre_ecole_CP"]   <- "ID_Etab_CP"
names(data_depp_1)[names(data_depp_1) == "id_neutre_classe_CP"]  <- "ID_Classe_CP"


# Language - First Period

names(data_depp_1)[names(data_depp_1) == "CPFCOMO_CP"] <- "T1_Comp_Mots"
names(data_depp_1)[names(data_depp_1) == "CPFCOPH_CP"] <- "T1_Comp_Phra"
names(data_depp_1)[names(data_depp_1) == "CPFCOTE_CP"] <- "T1_Comp_Text"
names(data_depp_1)[names(data_depp_1) == "CPFPHPH_CP"] <- "T1_Manip_Phon"
names(data_depp_1)[names(data_depp_1) == "CPFPHSY_CP"] <- "T1_Manip_Syll"
names(data_depp_1)[names(data_depp_1) == "CPFRLGP_CP"] <-"T1_Conn_Lettres"
names(data_depp_1)[names(data_depp_1) == "CPFRLLE_CP"] <- "T1_Recon_Ecritu_L"
names(data_depp_1)[names(data_depp_1) == "CPFRLSY_CP"] <- "T1_Compa_Lettres"



# Math - First Period
names(data_depp_1)[names(data_depp_1) == "CPMEGAS_CP"]     <- "T1_Assemblage"   
names(data_depp_1)[names(data_depp_1) == "CPMETNOCOEN_CP"] <- "T1_Ecri_Nombre"
names(data_depp_1)[names(data_depp_1) == "CPMETNOCORN_CP"] <- "T1_Lire_Nombre"
names(data_depp_1)[names(data_depp_1) == "CPMETNOPR_CP"]   <- "T1_Resoud_Pb"
names(data_depp_1)[names(data_depp_1) == "CPMUTNOCA_CP"]   <- "T1_Denombrer"
names(data_depp_1)[names(data_depp_1) == "CPMUTNOGN_CP"]   <- "T1_Compa_Nombre"
names(data_depp_1)[names(data_depp_1) == "CPMUTNOLN_CP"]   <- "T1_Ligne_Num"


# Language - Second Period

names(data_depp_1)[names(data_depp_1) == "CPFLICP_PE"]       <- "T2_Comp_Phra_Lu"

names(data_depp_1)[names(data_depp_1) == "CPFCOPH_PE"]       <- "T2_Comp_Phra"
names(data_depp_1)[names(data_depp_1) == "CPFLILVMO_PE"]     <- "T2_Lire_Mots"
names(data_depp_1)[names(data_depp_1) == "CPFLILVTE_PE"]     <- "T2_Lire_Text"
names(data_depp_1)[names(data_depp_1) == "CPFLOE_PE"]        <- "T2_Ecri_Syll"
names(data_depp_1)[names(data_depp_1) == "CPFLOR_PE"]        <- "T2_Ecri_Mots"
names(data_depp_1)[names(data_depp_1) == "CPFPHPH_PE"]       <- "T2_Manip_Phon"
names(data_depp_1)[names(data_depp_1) == "CPFRLGP_PE"]       <- "T2_Conn_Lettres"


# Math - Second Period

names(data_depp_1)[names(data_depp_1) == "CPMNOCACOGN_PE"]   <- "T2_Compa_Nombre"
names(data_depp_1)[names(data_depp_1) == "CPMNOCACOLN_PE"]   <- "T2_Ligne_Num"
names(data_depp_1)[names(data_depp_1) == "CPMNOCANECLAD_PE"] <- "T2_Addition"
names(data_depp_1)[names(data_depp_1) == "CPMNOCANECLSO_PE"] <- "T2_Soustract"
names(data_depp_1)[names(data_depp_1) == "CPMNOCANOEN_PE"]   <- "T2_Ecri_Nombre"
names(data_depp_1)[names(data_depp_1) == "CPMNOCARP_PE"]     <- "T2_Resoud_Pb"

  # Language - Third Period
  names(data_depp_1)[names(data_depp_1) == "CE1COMO_CE1"]            <- "T3_Comp_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1COPH_CE1"]            <- "T3_Comp_Phra"
  names(data_depp_1)[names(data_depp_1) == "CE1FLOE_CE1"]            <- "T3_Ecri_Syll"
  names(data_depp_1)[names(data_depp_1) == "CE1FLOR_CE1"]            <- "T3_Ecri_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1LICP_CE1"]            <- "T3_Comp_Phra_Lu"
  names(data_depp_1)[names(data_depp_1) == "CE1LICTEN_CE1"]          <- "T3_Comp_Text_Lu"
  names(data_depp_1)[names(data_depp_1) == "CE1LILVMO_CE1"]          <- "T3_Lire_Mots"
  names(data_depp_1)[names(data_depp_1) == "CE1LILVTE_CE1"]          <- "T3_Lire_Text"
  
  # Math - Third Period  
  names(data_depp_1)[names(data_depp_1) == "CE1MEGAS_CE1"]       <- "T3_Assemblage"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCACOLG_CE1"]   <- "T3_Ligne_Num"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECLAD_CE1"] <- "T3_Addition"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECLSO_CE1"] <- "T3_Soustract"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANECM_CE1"]   <- "T3_Calcul_Mental"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANOEN_CE1"]   <- "T3_Ecri_Nombre"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCANORC_CE1"]   <- "T3_Lire_Nombre"
  names(data_depp_1)[names(data_depp_1) == "CE1MNOCARP_CE1"]     <- "T3_Resoud_Pb"

}


Lang_T1 <- c("T1_Comp_Mots",
             "T1_Comp_Phra",
             "T1_Comp_Text",
             "T1_Manip_Phon",
             "T1_Manip_Syll",
             "T1_Conn_Lettres",
             "T1_Recon_Ecritu_L",
             "T1_Compa_Lettres")

Math_T1 <- c("T1_Ecri_Nombre",
             "T1_Lire_Nombre",
             "T1_Resoud_Pb",
             "T1_Denombrer",
             "T1_Compa_Nombre",
             "T1_Ligne_Num")

Lang_T2 <- c("T2_Comp_Phra",
             "T2_Lire_Mots",
             "T2_Lire_Text",
             "T2_Ecri_Syll",
             "T2_Ecri_Mots",
             "T2_Manip_Phon",
             "T2_Conn_Lettres")

Math_T2 <- c("T2_Compa_Nombre",
             "T2_Ligne_Num",
             "T2_Addition",
             "T2_Soustract",
             "T2_Ecri_Nombre",
             "T2_Resoud_Pb")

Lang_T3 <- c("T3_Comp_Mots",
             "T3_Comp_Phra",
             "T3_Ecri_Syll",
             "T3_Ecri_Mots",
             "T3_Comp_Phra_Lu",
             "T3_Comp_Text_Lu",
             "T3_Lire_Mots",
             "T3_Lire_Text")

Math_T3 <- c("T3_Assemblage",
             "T3_Ligne_Num",
             "T3_Addition",
             "T3_Soustract",
             "T3_Calcul_Mental",
             "T3_Ecri_Nombre",
             "T3_Lire_Nombre",
             "T3_Resoud_Pb")


```

##### Covariates to compare 

In order to compare similar tests between 2018 and 2019 and 2020

```{r echo=TRUE}


# SIMILAR (n:37) = The following list contains 37 tests for which the exact same tests were evaluated for cohort 1 and cohort 2 with identical number of items per tests

same_notes <- c("T1_Comp_Mots", "T1_Comp_Phra", "T1_Manip_Phon", "T1_Manip_Syll", "T1_Conn_Lettres","T1_Recon_Ecritu_L",
                "T1_Ecri_Nombre", "T1_Lire_Nombre", "T1_Resoud_Pb", "T1_Denombrer","T1_Ligne_Num",
                "T2_Comp_Phra","T2_Lire_Mots", "T2_Lire_Text", "T2_Ecri_Syll", "T2_Ecri_Mots", "T2_Manip_Phon", "T2_Conn_Lettres",
                "T2_Compa_Nombre", "T2_Ligne_Num","T2_Ecri_Nombre", "T2_Resoud_Pb", 
                "T3_Comp_Mots", "T3_Comp_Phra",  "T3_Ecri_Syll", "T3_Ecri_Mots", "T3_Comp_Phra_Lu", "T3_Comp_Text_Lu",
                "T3_Lire_Mots", "T3_Lire_Text",
                "T3_Assemblage", "T3_Ligne_Num", "T3_Calcul_Mental", "T3_Ecri_Nombre", "T3_Lire_Nombre","T3_Repres_Nb", "T3_Resoud_Pb")

# QUASI SIMILAR (n:44) = the following "notes" list, includes similar skills evaluated for cohort 2018  and 2019 BUT changes have been made for the 7 following tests (not the same number of items inside between the  2 cohorts):  "T1_Comp_Text", "T1_Compa_Lettres" , "T1_Compa_Nombre", "T2_Addition" ,"T2_Soustract",  "T3_Addition" , "T3_Soustract"

notes <- c(Lang_T1, Math_T1, Lang_T2, Math_T2, Lang_T3, Math_T3) 

```


Note that the data contains `r ncol(data_depp_1)`.

```{r eval=FALSE, include=FALSE}

# sanity check : data exploration

if(ANNEE_COHORTE == 2019){
  print("Note that for cohort 2019, there exist a different IPS at mid year, and not beginning of year. In particular the number of etablishment presenting a different IPS is: ")
  print(sum(data_depp_1$IPS_Etab_T2 != data_depp_1$IPS_Etab_CP, na.rm = TRUE))
  
  print("In particular the number of etablishment presenting a different category is: ")
  print(sum(data_depp_1$Categ_Etab_T2 != data_depp_1$Categ_Etab_CP, na.rm = TRUE))
  
  ggplot(data_depp_1, aes(x = IPS_Etab_T2, y = IPS_Etab_CP)) +
    geom_point() +
    theme_classic() +
    xlab("IPS (middle of year)") +
    ylab("IPS (September)") 
    ggsave(paste0("~/img/",ANNEE_COHORTE,"/change_ips_during_year_etab_", ANNEE_COHORTE,".pdf"))
  
  ggplot(data_depp_1, aes(x = Categ_Etab_T2, y = Categ_Etab_CP)) +
    geom_jitter() +
    theme_classic() +
    xlab("Category (middle of year)") +
    ylab("Category (September)") 
  ggsave(paste0("~/img/",ANNEE_COHORTE,"/change_category_during_year_etab_", ANNEE_COHORTE,".pdf"))
  

  # Note that the IPS at middle of year is also missing when it is missing in the first period, therefore the column at middle of year can not be used to impute  beginning of year
  # sum(is.na(data_depp_1$IPS_Etab_CP) & is.na(data_depp_1$IPS_Etab_T2))
  # And there are no missing values for Category, so no need to impute
}

if (ANNEE_COHORTE == 2020){
  print("Note that for cohort 2020, there exist a different IPS at mid year, and not beginning of year. In particular the number of etablishment presenting a different IPS is: ")
  print(sum(data_depp_1$ips_Mi != data_depp_1$IPS_Etab_CP, na.rm = TRUE))
  
  print("In particular the number of etablishment presenting a different category is: ")
  print(sum(data_depp_1$strate_Mi != data_depp_1$Categ_Etab_CP, na.rm = TRUE))
  
  ggplot(data_depp_1, aes(x = ips_Mi, y = IPS_Etab_CP)) +
    geom_point() +
    theme_classic() +
    xlab("IPS (middle of year)") +
    ylab("IPS (September)") 
    ggsave(paste0("~/img/",ANNEE_COHORTE,"/change_ips_during_year_etab_", ANNEE_COHORTE,".pdf"))
  
  ggplot(data_depp_1, aes(x = strate_Mi, y = Categ_Etab_CP)) +
    geom_jitter() +
    theme_classic() +
    xlab("Category (middle of year)") +
    ylab("Category (September)") 
  ggsave(paste0("~/img/",ANNEE_COHORTE,"/change_category_during_year_etab_", ANNEE_COHORTE,".pdf"))
  
}

```


##### Rename categories

```{r}
if(ANNEE_COHORTE == 2018){
data_depp_1$Categ_Etab_CP <- case_when(data_depp_1$Categ_Etab_CP == "Public Hors REP" ~ "Public",
                                       data_depp_1$Categ_Etab_CP == "Prive" ~ "Private",
                                       data_depp_1$Categ_Etab_CP == "REP" ~ "REP",
                                       data_depp_1$Categ_Etab_CP == "REP+" ~ "REP+")

data_depp_1$Categ_Etab_CP <- factor(data_depp_1$Categ_Etab_CP, 
                                 levels = c("Private","Public", "REP", "REP+"))

} else if (ANNEE_COHORTE == 2019){
data_depp_1$Categ_Etab_CP <- case_when(data_depp_1$Categ_Etab_CP == "Public Hors EP" ~ "Public",
                                       data_depp_1$Categ_Etab_CP == "Prive" ~ "Private",
                                       data_depp_1$Categ_Etab_CP == "REP" ~ "REP",
                                       data_depp_1$Categ_Etab_CP == "REP+" ~ "REP+")

data_depp_1$Categ_Etab_CP <- factor(data_depp_1$Categ_Etab_CP, 
                                 levels = c("Private","Public", "REP", "REP+"))

} else if (ANNEE_COHORTE == 2020){
data_depp_1$Categ_Etab_CP <- case_when(data_depp_1$Categ_Etab_CP == "Public Hors EP" ~ "Public",
                                       data_depp_1$Categ_Etab_CP == "Prive" ~ "Private",
                                       data_depp_1$Categ_Etab_CP == "REP" ~ "REP",
                                       data_depp_1$Categ_Etab_CP == "REP+" ~ "REP+")

data_depp_1$Categ_Etab_CP <- factor(data_depp_1$Categ_Etab_CP, 
                                 levels = c("Private","Public", "REP", "REP+"))


} else if (ANNEE_COHORTE == 2021){
  

data_depp_1$Categ_Etab_CP <- as.factor(data_depp_1$Categ_Etab_CP)

data_depp_1$Categ_Etab_CP <- case_when(data_depp_1$Categ_Etab_CP == "Public Hors EP" ~ "Public",
                                       data_depp_1$Categ_Etab_CP == "Prive" ~ "Private",
                                       data_depp_1$Categ_Etab_CP == "REP" ~ "REP",
                                       data_depp_1$Categ_Etab_CP == "REP+" ~ "REP+")


data_depp_1$Categ_Etab_CP <- factor(data_depp_1$Categ_Etab_CP, 
                                 levels = c("Private","Public", "REP", "REP+"))  
summary(data_depp_1$Categ_Etab_CP)
}


```



##### Creation of age variable

Note that birth date is stored as YEAR-MONTH in the raw data frame, for example:

```{r}
print(data_depp_1$Date_Naiss[1:10])
```

Check if any missing birth date in the data

```{r}
# Control for missing data in year

if (sum(is.na(data_depp_1$Date_Naiss)) > 0){
  print(paste0("WARNING: ", sum(is.na(data_depp_1$Date_Naiss)), " row(s) miss birth date"))
} else {
  print("GOOD: all birthdates are present")
}

```


```{r}
# Create year and month from the column Date_Naiss

year     <- as.integer(substring(data_depp_1$Date_Naiss, 1, 4)) 
month    <- as.integer(substring(data_depp_1$Date_Naiss, 6, 7))



# sanity checks (all months values are in the good range, and all years are with 4 digits after 2000)
if(!any(month %in% 1:12)){print('WARNING: some month values are out of range')} else {print("GOOD: month values are all coherent")}
if(!any(year %in% 2000:2021)){print('WARNING: some year values are out of range')} else {print("GOOD: year values are all coherent")}

# Create age

data_depp_1$Age_CP  <- (ANNEE_COHORTE - year)*12 + (9-month)
data_depp_1$Age_CP <- as.numeric(data_depp_1$Age_CP)
summary(data_depp_1$Age_CP)


# Flag normal age or not
data_depp_1$Age_categ <- case_when(data_depp_1$Age_CP >= AGE_MIN & data_depp_1$Age_CP < AGE_PRECOCE       ~ "Young", # 1 year ahead
                                AGE_PRECOCE <= data_depp_1$Age_CP & data_depp_1$Age_CP <= AGE_RETARD    ~ "Normal",
                                data_depp_1$Age_CP > AGE_RETARD & data_depp_1$Age_CP <= AGE_MAX         ~ "Late") # 1 year late
# reorder columns 
data_depp_1$Age_categ <- factor(data_depp_1$Age_categ, levels = c("Young", "Normal" , "Late"))
summary(data_depp_1$Age_categ)



```

##### Replace outliers for age (below AGE_MIN or above AGE_MAX) by NA for Age.

Number of remaining observations before removal of age outliers is `r nrow(data_depp_1)`

```{r echo=TRUE}

data_depp_1$age_abnormality <- ifelse(data_depp_1$Age_CP < AGE_MIN |  data_depp_1$Age_CP > AGE_MAX, TRUE, FALSE) # mean +/- 1.5 year 
print(paste0("Number of abnormal ages (below AGE_MIN and above AGE_MAX): ", sum(data_depp_1$age_abnormality, na.rm = TRUE)))

# sanity check

table(data_depp_1$age_abnormality)                     # n = 152    # (2020) 374  # (2021) 446
nrow(data_depp_1[is.na(data_depp_1$age_abnormality),]) # n = 19     # (2020)  60  # (2021) 25716
nrow(data_depp_1[data_depp_1$age_abnormality,])        # n = 171    # (2020)  434 # 2021 2662
 

# Replace Age outliers with NA 
  
data_depp_1$Age_CP <- ifelse(data_depp_1$age_abnormality == TRUE , NA, data_depp_1$Age_CP) 
nrow(data_depp_1[is.na(data_depp_1$Age_CP),]) # n = 434   # n = 26162 for 2021

# nb of obs with age outilers

nrow(data_depp_1[data_depp_1$age_abnormality,])

```

Number of observations with age outliers is `r nrow(data_depp_1[data_depp_1$age_abnormality,])`


##### Analyzing missings values 

```{r echo=TRUE}

number_of_missing_values <- n_miss(data_depp_1) # function equivalent to sum(is.na(data))
total_number_of_items <- nrow(data_depp_1)*ncol(data_depp_1)
percentage_of_missing_values <- 100* number_of_missing_values / total_number_of_items
number_of_observations_with_NA <- nrow(data_depp_1) - nrow(na.omit(data_depp_1)) 
percentage_of_row_with_at_least_1_NA <- 100* number_of_observations_with_NA / nrow(data_depp_1)

print(paste0("The total number of missing values is ", number_of_missing_values, 
             " while the total of values is ", total_number_of_items, ". ",
             "This corresponds to a percentage of ", round(percentage_of_missing_values,3), "%. ",
             "The number of children (observation or row) with at least one missing value: ", number_of_observations_with_NA, ". ",
             "This corresponds to a percentage of ", round(percentage_of_row_with_at_least_1_NA,3), "%. "))


data_depp_non_imp_2 <- data_depp_1
```


```{r}
data_depp_1$T2_Lire_Mots[data_depp_1$T2_Lire_Mots > 100] <- NA
data_depp_1$T2_Lire_Text[data_depp_1$T2_Lire_Text > 195] <- NA
data_depp_1$T3_Lire_Mots[data_depp_1$T3_Lire_Mots > 93] <- NA
data_depp_1$T3_Lire_Text[data_depp_1$T3_Lire_Text > 136] <- NA
data_depp_1$T2_Lire_Mots_Cut     <- as.numeric(ifelse(data_depp_1$T2_Lire_Mots > 30, NaN, data_depp_1$T2_Lire_Mots))
data_depp_1$T2_Lire_Text_Cut     <- as.numeric(ifelse(data_depp_1$T2_Lire_Text > 29, NaN, data_depp_1$T2_Lire_Text))
data_depp_1$T3_Lire_Mots_Cut     <- as.numeric(ifelse(data_depp_1$T3_Lire_Mots > 60, NaN, data_depp_1$T3_Lire_Mots))
data_depp_1$T3_Lire_Text_Cut     <- as.numeric(ifelse(data_depp_1$T3_Lire_Text > 102, NaN, data_depp_1$T3_Lire_Text))
Fluency_With_Cut <- c("T2_Lire_Mots_Cut", "T2_Lire_Text_Cut", "T3_Lire_Mots_Cut", "T3_Lire_Text_Cut") # fluency with hardcuts

 data_depp_1$T1_FR_ZNA <- rowSums(is.na(data_depp_1[, Lang_T1]) | data_depp_1[,Lang_T1] == 0)
  data_depp_1$T1_MA_ZNA <- rowSums(is.na(data_depp_1[, Math_T1]) | data_depp_1[,Math_T1] == 0)
  data_depp_1$T2_FR_ZNA <- rowSums(is.na(data_depp_1[, Lang_T2]) | data_depp_1[,Lang_T2] == 0)
  data_depp_1$T2_MA_ZNA <- rowSums(is.na(data_depp_1[, Math_T2]) | data_depp_1[, Math_T2] == 0)
  data_depp_1$T3_FR_ZNA <- rowSums(is.na(data_depp_1[, Lang_T3]) | data_depp_1[, Lang_T3] == 0)
  data_depp_1$T3_MA_ZNA <- rowSums(is.na(data_depp_1[, Math_T3]) | data_depp_1[, Math_T3] == 0)
  
data_depp_1$test_abnormalities_Lang_T1 <- ifelse(data_depp_1$T1_FR_ZNA > length(Lang_T1) - 3, 1, 0) 
data_depp_1$test_abnormalities_Math_T1 <- ifelse(data_depp_1$T1_MA_ZNA > length(Math_T1) - 2 , 1, 0) 
data_depp_1$test_abnormalities_T1      <- ifelse(data_depp_1$test_abnormalities_Lang_T1 == 1 & data_depp_1$test_abnormalities_Math_T1 == 1, 1, 0)
data_depp_1$test_abnormalities_Lang_T2 <- ifelse(data_depp_1$T2_FR_ZNA > length(Lang_T2) - 3, 1, 0) 
data_depp_1$test_abnormalities_Math_T2 <- ifelse(data_depp_1$T2_MA_ZNA > length(Math_T2) - 2 , 1, 0) 
data_depp_1$test_abnormalities_T2      <- ifelse(data_depp_1$test_abnormalities_Lang_T2 == 1 & data_depp_1$test_abnormalities_Math_T2 == 1, 1, 0)

data_depp_1$test_abnormalities_Lang_T3 <- ifelse(data_depp_1$T3_FR_ZNA > length(Lang_T3) - 3, 1, 0) 
data_depp_1$test_abnormalities_Math_T3 <- ifelse(data_depp_1$T3_MA_ZNA > length(Math_T3) - 3, 1, 0) 
data_depp_1$test_abnormalities_T3      <- ifelse(data_depp_1$test_abnormalities_Lang_T3 == 1 & data_depp_1$test_abnormalities_Math_T3 == 1, 1, 0)

data_depp_1$totally_ab <- ifelse((data_depp_1$test_abnormalities_T1 == 1) &
                                           (data_depp_1$test_abnormalities_T2 == 1) &
                                           (data_depp_1$test_abnormalities_T3 == 1), 1, 0)
table(data_depp_1$totally_ab)

data_depp_1 <- data_depp_1[!data_depp_1$totally_ab,]



```

```{r}

data_depp_1$ID_etab_class <- paste(data_depp_1$ID_Etab_CP, data_depp_1$ID_Classe_CP, sep = "_")
length(unique(data_depp_1$ID_etab_class))
Nb_Per_Class <- data_depp_1[, c("ID_etab_class", "ID_Eleve")] %>%
  group_by(ID_etab_class) %>%
  summarise(Taille_Classe = n())
data_depp_1 <- merge(Nb_Per_Class, data_depp_1, by = "ID_etab_class")

classes_without_Sexe <- unique(data_depp_1[is.na(data_depp_1$Sexe), c("ID_etab_class")]) 
data_depp_1 <- data_depp_1[ ! (data_depp_1$ID_etab_class %in% classes_without_Sexe) , ]

```

```{r}

data_depp_non_imp_1 <- data_depp_1
rm(data_depp_1)

```

# Table S3 - Sensitivity analysis

```{r}
knitr::opts_chunk$set(echo = TRUE)

# Data to compare

# joined_imputed

load("~/Desktop/education/data/cohort_2018_imputed_joined.RData")
joined_imputed    <- joined
rm(joined)

# data_depp_non_imputed_naomit_False : Load SCRIPT 1 for data_depp_non_imp_1

data_depp_non_imputed_naomit_False <- data_depp_non_imp_1 

# data_depp_non_imputed_naomit_True : Create na.omit True from data_depp_non_imp_1

data_depp_non_imputed_naomit_True <- na.omit(data_depp_non_imp_2)
rm(data_depp_non_imp_1)

```

```{r}
# For data_depp_non_imputed_naomit_True : We skip the part were we add NA for students that were almost absent for a test

data_depp_non_imputed_naomit_True$ID_etab_class <- paste(data_depp_non_imputed_naomit_True$ID_Etab_CP, data_depp_non_imputed_naomit_True$ID_Classe_CP, sep = "_")
length(unique(data_depp_non_imputed_naomit_True$ID_etab_class))
Nb_Per_Class <- data_depp_non_imputed_naomit_True[, c("ID_etab_class", "ID_Eleve")] %>%
  group_by(ID_etab_class) %>%
  summarise(Taille_Classe = n())
data_depp_non_imputed_naomit_True <- merge(Nb_Per_Class, data_depp_non_imputed_naomit_True, by = "ID_etab_class")

classes_without_Sexe <- unique(data_depp_non_imputed_naomit_True[is.na(data_depp_non_imputed_naomit_True$Sexe), c("ID_etab_class")]) 
data_depp_non_imputed_naomit_True <- data_depp_non_imputed_naomit_True[ ! (data_depp_non_imputed_naomit_True$ID_etab_class %in% classes_without_Sexe) , ]

```

```{r}
# Selection of class size

data_depp_non_imputed_naomit_True <- data_depp_non_imputed_naomit_True[data_depp_non_imputed_naomit_True$Taille_Classe < SEUIL_SUP_CLASS & data_depp_non_imputed_naomit_True$Taille_Classe > SEUIL_INF_CLASS,]

data_depp_non_imputed_naomit_False <- data_depp_non_imputed_naomit_False[data_depp_non_imputed_naomit_False$Taille_Classe < SEUIL_SUP_CLASS & data_depp_non_imputed_naomit_False$Taille_Classe > SEUIL_INF_CLASS,]

```


# Gaussianize 

1) Gaussianize : data_depp_non_imputed_naomit_True
2) Gaussianize : data_depp_non_imputed_naomit_False

### Gaussianize data_depp_non_imputed_naomit_True




```{r}
# Create _P variables for data_depp_na_omit_true and false

Lang_T1_P       <- paste(Lang_T1, "_P", sep="")
Lang_T2_P       <- paste(Lang_T2, "_P", sep="")
Lang_T3_P       <- paste(Lang_T3, "_P", sep="")
Math_T1_P       <- paste(Math_T1, "_P", sep="")
Math_T2_P       <- paste(Math_T2, "_P", sep="")
Math_T3_P       <- paste(Math_T3, "_P", sep="")

# Creating variables _P as the percentage of success per variable ranging from 0 to 100.

 for (i in c(Lang_T1, Lang_T2, Lang_T3, Math_T1, Math_T2, Math_T3)){
    
    data_depp_non_imputed_naomit_False[[paste0(i, "_P")]] <- (data_depp_non_imputed_naomit_False[[i]] - min(data_depp_non_imputed_naomit_False[, i], na.rm = TRUE)) / (max(data_depp_non_imputed_naomit_False[, i], na.rm = TRUE) - min(data_depp_non_imputed_naomit_False[, i], na.rm = TRUE))*100
    
 }

dim(data_depp_non_imputed_naomit_False)

# Creating variables _P as the percentage of success per variable ranging from 0 to 100.

 for (i in c(Lang_T1, Lang_T2, Lang_T3, Math_T1, Math_T2, Math_T3)){
    
    data_depp_non_imputed_naomit_True[[paste0(i, "_P")]] <- (data_depp_non_imputed_naomit_True[[i]] - min(data_depp_non_imputed_naomit_True[, i], na.rm = TRUE)) / (max(data_depp_non_imputed_naomit_True[, i], na.rm = TRUE) - min(data_depp_non_imputed_naomit_True[, i], na.rm = TRUE))*100
    
 }

dim(data_depp_non_imputed_naomit_True)
```

```{r}
## computing variables

data_depp_non_imputed_naomit_False$T1_Language <- apply(data_depp_non_imputed_naomit_False[ , c(Lang_T1_P)], 1, mean, na.rm = TRUE)
data_depp_non_imputed_naomit_False$T2_Language <- apply(data_depp_non_imputed_naomit_False[ , c(Lang_T2_P)], 1, mean, na.rm = TRUE)
data_depp_non_imputed_naomit_False$T3_Language <- apply(data_depp_non_imputed_naomit_False[ , c(Lang_T3_P)], 1, mean, na.rm = TRUE)
data_depp_non_imputed_naomit_False$T1_Math <- apply(data_depp_non_imputed_naomit_False[ , c(Math_T1_P)], 1, mean, na.rm = TRUE)
data_depp_non_imputed_naomit_False$T2_Math <- apply(data_depp_non_imputed_naomit_False[ , c(Math_T2_P)], 1, mean, na.rm = TRUE)
data_depp_non_imputed_naomit_False$T3_Math <- apply(data_depp_non_imputed_naomit_False[ , c(Math_T3_P)], 1, mean, na.rm = TRUE)


data_depp_non_imputed_naomit_True$T1_Language <- apply(data_depp_non_imputed_naomit_True[ , c(Lang_T1_P)], 1, mean, na.rm = TRUE)
data_depp_non_imputed_naomit_True$T2_Language <- apply(data_depp_non_imputed_naomit_True[ , c(Lang_T2_P)], 1, mean, na.rm = TRUE)
data_depp_non_imputed_naomit_True$T3_Language <- apply(data_depp_non_imputed_naomit_True[ , c(Lang_T3_P)], 1, mean, na.rm = TRUE)
data_depp_non_imputed_naomit_True$T1_Math <- apply(data_depp_non_imputed_naomit_True[ , c(Math_T1_P)], 1, mean, na.rm = TRUE)
data_depp_non_imputed_naomit_True$T2_Math <- apply(data_depp_non_imputed_naomit_True[ , c(Math_T2_P)], 1, mean, na.rm = TRUE)
data_depp_non_imputed_naomit_True$T3_Math <- apply(data_depp_non_imputed_naomit_True[ , c(Math_T3_P)], 1, mean, na.rm = TRUE)
```


 "Categ_Etab_CP", "ID_etab_class", 
 ,"Sexe_NUM", 
```{r}

library(jtools)
library(LambertW)
library(reshape2)

data_depp_non_imputed_naomit_True$Sexe_NUM <- case_when(data_depp_non_imputed_naomit_True$Sexe == "Garcon" ~ "0.5",
                                                        data_depp_non_imputed_naomit_True$Sexe == "Fille" ~ "-0.5")
data_depp_non_imputed_naomit_True$Sexe_NUM <- as.numeric(data_depp_non_imputed_naomit_True$Sexe_NUM)

data_depp_non_imputed_naomit_False$Sexe_NUM <- case_when(data_depp_non_imputed_naomit_False$Sexe == "Garcon" ~ "0.5",
                                                        data_depp_non_imputed_naomit_False$Sexe == "Fille" ~ "-0.5")
data_depp_non_imputed_naomit_False$Sexe_NUM <- as.numeric(data_depp_non_imputed_naomit_False$Sexe_NUM)


joined_gau    <- as.data.frame(Gaussianize(data_depp_non_imputed_naomit_True[, c("Age_CP", "Taille_Classe", "IPS_Etab_CP", "Sexe_NUM",
                                                                                 "T1_Math", "T2_Math", "T3_Math",
                                                                                 "T1_Language", "T2_Language", "T3_Language",
                                                                                 "T1_Resoud_Pb_P", "T2_Resoud_Pb_P", "T3_Resoud_Pb_P",
                                                                                 "T1_Ligne_Num_P", "T2_Ligne_Num_P", "T3_Ligne_Num_P")],
                                         type = c("s"), method = c("IGMM"), return.u = TRUE))

joined_gau    <- as.data.frame(Gaussianize(data_depp_non_imputed_naomit_False[, c("Age_CP", "Taille_Classe", "IPS_Etab_CP","Sexe_NUM",
                                                                                 "T1_Math", "T2_Math", "T3_Math",
                                                                                 "T1_Language", "T2_Language", "T3_Language",
                                                                                 "T1_Resoud_Pb_P", "T2_Resoud_Pb_P", "T3_Resoud_Pb_P",
                                                                                 "T1_Ligne_Num_P", "T2_Ligne_Num_P", "T3_Ligne_Num_P")],
                                         type = c("s"), method = c("IGMM"), return.u = TRUE))

```



Comparing 
1) Joined_Fin_3 (equivalent to gaussianize joined)
2) Gaussianize : data_depp_non_imputed_naomit_True
3) Gaussianize : data_depp_non_imputed_naomit_False

```{r}
# Selection of variables to compare

joined_imputed <- joined_imputed[ , c("ID_etab_class","Age_CP", "Taille_Classe", "IPS_Etab_CP", "Sexe",  "Categ_Etab_CP",
                                      "T1_Math", "T2_Math", "T3_Math", "T1_Resoud_Pb_P", "T2_Resoud_Pb_P", "T3_Resoud_Pb_P",
                                      "T1_Ligne_Num_P", "T2_Ligne_Num_P", "T3_Ligne_Num_P","T1_Language", "T2_Language", "T3_Language")]

data_depp_non_imputed_naomit_True <- data_depp_non_imputed_naomit_True [ , c("ID_etab_class","Age_CP", "Taille_Classe", "IPS_Etab_CP",
                                                                             "Sexe",  "Categ_Etab_CP",
                                      "T1_Math", "T2_Math", "T3_Math", "T1_Resoud_Pb_P", "T2_Resoud_Pb_P", "T3_Resoud_Pb_P",
                                      "T1_Ligne_Num_P", "T2_Ligne_Num_P", "T3_Ligne_Num_P","T1_Language", "T2_Language", "T3_Language")]

data_depp_non_imputed_naomit_False <- data_depp_non_imputed_naomit_False [ , c("ID_etab_class","Age_CP", "Taille_Classe", "IPS_Etab_CP",
                                                                               "Sexe",  "Categ_Etab_CP",
                                      "T1_Math", "T2_Math", "T3_Math", "T1_Resoud_Pb_P", "T2_Resoud_Pb_P", "T3_Resoud_Pb_P",
                                      "T1_Ligne_Num_P", "T2_Ligne_Num_P", "T3_Ligne_Num_P","T1_Language", "T2_Language", "T3_Language")]


rm(Nb_Per_Class)
```



```{r}

# Concatener

joined_imputed$Groupe <- 1
joined_imputed$Groupe <- as.factor(joined_imputed$Groupe)
data_depp_non_imputed_naomit_False$Groupe <- 2
data_depp_non_imputed_naomit_False$Groupe <- as.factor(data_depp_non_imputed_naomit_False$Groupe)
data_depp_non_imputed_naomit_True$Groupe <- 3
data_depp_non_imputed_naomit_True$Groupe <- as.factor(data_depp_non_imputed_naomit_True$Groupe)

DATA_totale_false <- rbind(joined_imputed, data_depp_non_imputed_naomit_False)
DATA_totale_true <- rbind(joined_imputed, data_depp_non_imputed_naomit_True)

# Create a variable list which we want in Table 1
listVars_BIS <- c("Age_CP", "Taille_Classe", "IPS_Etab_CP","T1_Math", "T2_Math", "T3_Math",
                  "T1_Resoud_Pb_P", "T2_Resoud_Pb_P", "T3_Resoud_Pb_P",
                  "T1_Ligne_Num_P", "T2_Ligne_Num_P", "T3_Ligne_Num_P",
                  "T1_Language", "T2_Language", "T3_Language")
                  
# Define categorical variables

catVars <- c("Categ_Etab_CP", "Sexe", "Groupe")

table1 <- CreateTableOne(vars = c(listVars_BIS, catVars), 
                         factorVars = catVars,
                         strata = "Groupe",
                         data = DATA_totale_false) 


a <- print(table1, 
           quote = TRUE, 
           noSpaces = TRUE,
           showAllLevels = TRUE) # last option is for showing both all categories, for e.g. boys and girls
a
df <- data.frame(a)
df
write.csv(df, paste0("~/table/table_S3_data_depp_", ANNEE_COHORTE, "_imputed_vs_nonimputed_naofalse_1stpart.csv"), row.names = TRUE)

table1 <- CreateTableOne(vars = c(listVars_BIS, catVars), 
                         factorVars = catVars,
                         strata = "Groupe",
                         data = DATA_totale_true) 


a <- print(table1, 
           quote = TRUE, 
           noSpaces = TRUE,
           showAllLevels = TRUE) # last option is for showing both all categories, for e.g. boys and girls
a
df <- data.frame(a)
df
write.csv(df, paste0("~/table/table_S3_data_depp_", ANNEE_COHORTE, "_imputed_vs_nonimputed_naotrue_1stpart.csv"), row.names = TRUE)

```




# Table S4 - t tests and Cohen s d 


```{r}
# Data


knitr::opts_chunk$set(echo = TRUE)

# Parameters to set before launch of the pipeline
IMPUTED = "imputed" # "imputed" "non-imputed"
ANNEE_COHORTE = "2021" 

# Library

library(ggplot2)
library(FactoMineR)
library(dplyr)
library(tidyverse)

library(broom)
library(jtools)
library(boot)
library(tidyr)
library(table1)
library(htmlTable)
library(knitr)
library(reshape2)
library(tableone)

library(fastmap)


if(IMPUTED == "non-imputed"){
  
load(paste0("~/Data/cohort_", ANNEE_COHORTE,"_non-imputed_after_2_composite_covariate.RData"))
load(paste0("~/Data/cohort_", ANNEE_COHORTE,"_non-imputed_joined_n.RData"))

} 

if(IMPUTED == "imputed"){

load(paste0("~/Data/cohort_", ANNEE_COHORTE,"_imputed_after_2_composite_covariate.RData"))
load(paste0("~/Data/cohort_", ANNEE_COHORTE,"_imputed_joined_n.RData"))

} 

Lang_T2_P <- c("T2_Comp_Phra_P","T2_Lire_Mots_P","T2_Lire_Text_P", "T2_Ecri_Syll_P",
               "T2_Ecri_Mots_P", "T2_Manip_Phon_P", "T2_Conn_Lettres_P")
Math_T2_P <- c("T2_Compa_Nombre_P", "T2_Ligne_Num_P", "T2_Ecri_Nombre_P", "T2_Resoud_Pb_P",
               "T2_Addition_P", "T2_Soustract_P")







# Table S4 : gender gaps
# 
# We want to have the measure of gender gap per domain ("T1_Math", "T2_Math", "T3_Math", "T1_Resoud_Pb_P", "T2_Resoud_Pb_P", "T3_Resoud_Pb_P","T1_Ligne_Num_P", "T2_Ligne_Num_P", "T3_Ligne_Num_P", "T1_Language", "T2_Language","T3_Language") and its significance.



# Data selection

joined_n_S4 <- joined_n[ , c("Sexe", "T1_Math", "T2_Math", "T3_Math", "T1_Math_Rank", "T2_Math_Rank", "T3_Math_Rank", 
                             "T1_Resoud_Pb_P", "T2_Resoud_Pb_P",
                             "T3_Resoud_Pb_P", "T1_Ligne_Num_P", "T2_Ligne_Num_P", "T3_Ligne_Num_P",
                             "T1_Resoud_Pb_P_Rank", "T2_Resoud_Pb_P_Rank",
                             "T3_Resoud_Pb_P_Rank", "T1_Ligne_Num_P_Rank", "T2_Ligne_Num_P_Rank", "T3_Ligne_Num_P_Rank",
                             "T1_Language", "T2_Language", "T3_Language",
                             "T1_Lang_Rank", "T2_Lang_Rank", "T3_Lang_Rank")] 



# Math 

Data_Math_T1 <- joined_n_S4 %>%
  t_test(T1_Math ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_Math_T2 <- joined_n_S4 %>%
  t_test(T2_Math ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_Math_T3 <- joined_n_S4 %>%
  t_test(T3_Math ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

DATA_Math_Tot <- rbind(Data_Math_T1, Data_Math_T2, Data_Math_T3)
DATA_Math_Tot <- data.frame(DATA_Math_Tot)
rm(Data_Math_T1, Data_Math_T2, Data_Math_T3)

# Ligne num

Data_Math_T1 <- joined_n_S4 %>%
  t_test(T1_Ligne_Num_P ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_Math_T2 <- joined_n_S4 %>%
  t_test(T2_Ligne_Num_P ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_Math_T3 <- joined_n_S4 %>%
  t_test(T3_Ligne_Num_P ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

DATA_LN_Tot <- rbind(Data_Math_T1, Data_Math_T2, Data_Math_T3)
DATA_LN_Tot <- data.frame(DATA_LN_Tot)
rm(Data_Math_T1, Data_Math_T2, Data_Math_T3)

# Resoud Pb

Data_Math_T1 <- joined_n_S4 %>%
  t_test(T1_Resoud_Pb_P ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_Math_T2 <- joined_n_S4 %>%
  t_test(T2_Resoud_Pb_P ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_Math_T3 <- joined_n_S4 %>%
  t_test(T3_Resoud_Pb_P ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

DATA_ResPb_Tot <- rbind(Data_Math_T1, Data_Math_T2, Data_Math_T3)
DATA_ResPb_Tot <- data.frame(DATA_ResPb_Tot)
rm(Data_Math_T1, Data_Math_T2, Data_Math_T3)


# Language

Data_Math_T1 <- joined_n_S4 %>%
  t_test(T1_Language ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_Math_T2 <- joined_n_S4 %>%
  t_test(T2_Language ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_Math_T3 <- joined_n_S4 %>%
  t_test(T3_Language ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

DATA_Lang_Tot <- rbind(Data_Math_T1, Data_Math_T2, Data_Math_T3)
DATA_Lang_Tot <- data.frame(DATA_Lang_Tot)
rm(Data_Math_T1, Data_Math_T2, Data_Math_T3)


# Math Rank

Data_MathR_T1 <- joined_n_S4 %>%
  t_test(T1_Math_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_MathR_T2 <- joined_n_S4 %>%
  t_test(T2_Math_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_MathR_T3 <- joined_n_S4 %>%
  t_test(T3_Math_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

DATA_MathR_Tot <- rbind(Data_MathR_T1, Data_MathR_T2, Data_MathR_T3)
DATA_MathR_Tot <- data.frame(DATA_MathR_Tot)
rm(Data_MathR_T1, Data_MathR_T2, Data_MathR_T3)

# Ligne Num Rank

Data_MathR_T1 <- joined_n_S4 %>%
  t_test(T1_Ligne_Num_P_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_MathR_T2 <- joined_n_S4 %>%
  t_test(T2_Ligne_Num_P_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_MathR_T3 <- joined_n_S4 %>%
  t_test(T3_Ligne_Num_P_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

DATA_LNR_Tot <- rbind(Data_MathR_T1, Data_MathR_T2, Data_MathR_T3)
DATA_LNR_Tot <- data.frame(DATA_LNR_Tot)
rm(Data_MathR_T1, Data_MathR_T2, Data_MathR_T3)


# Resoud pb Rank

Data_MathR_T1 <- joined_n_S4 %>%
  t_test(T1_Resoud_Pb_P_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_MathR_T2 <- joined_n_S4 %>%
  t_test(T2_Resoud_Pb_P_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_MathR_T3 <- joined_n_S4 %>%
  t_test(T3_Resoud_Pb_P_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

DATA_ResPbR_Tot <- rbind(Data_MathR_T1, Data_MathR_T2, Data_MathR_T3)
DATA_ResPbR_Tot <- data.frame(DATA_ResPbR_Tot)
rm(Data_MathR_T1, Data_MathR_T2, Data_MathR_T3)



# Language Rank

Data_MathR_T1 <- joined_n_S4 %>%
  t_test(T1_Lang_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_MathR_T2 <- joined_n_S4 %>%
  t_test(T2_Lang_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

Data_MathR_T3 <- joined_n_S4 %>%
  t_test(T3_Lang_Rank ~ Sexe,
         var.equal = TRUE,
         detailed = TRUE)

DATA_LangR_Tot <- rbind(Data_MathR_T1, Data_MathR_T2, Data_MathR_T3)
DATA_LangR_Tot <- data.frame(DATA_LangR_Tot)
rm(Data_MathR_T1, Data_MathR_T2, Data_MathR_T3)



# Rbind total

DATA_Ttest_Tot <- rbind(DATA_Math_Tot, DATA_LN_Tot, DATA_ResPb_Tot, DATA_Lang_Tot,
                        DATA_MathR_Tot, DATA_LNR_Tot, DATA_ResPbR_Tot, DATA_LangR_Tot)
DATA_Ttest_Tot <- as.data.frame(DATA_Ttest_Tot)

rm(DATA_Math_Tot, DATA_LN_Tot, DATA_ResPb_Tot, DATA_Lang_Tot,
                        DATA_MathR_Tot, DATA_LNR_Tot, DATA_ResPbR_Tot, DATA_LangR_Tot)

write_csv2(DATA_Ttest_Tot, file= paste0("~/table/table_S4_Gendergap_Firstessai_t_test_joined_n_", ANNEE_COHORTE, "_mean_diff.csv"))
rm(DATA_Ttest_Tot)






# Cohen s D

### Joined_n : Cohens d in Math T1 T2 T3

# Data T1

DATA_Cohen <- joined_n[ , c("Sexe", "T1_Math")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T1_Math <- as.numeric(DATA_Cohen$T1_Math)
DATA_C5 <- DATA_Cohen %>%
  cohens_d(T1_Math ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1 <- data.frame(DATA_C5)

# Data T2

DATA_Cohen <- joined_n[ , c("Sexe", "T2_Math")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T2_Math <- as.numeric(DATA_Cohen$T2_Math)
DATA_C6 <- DATA_Cohen %>%
  cohens_d(T2_Math ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C6)[1] <- "Time"
DATA_T2 <- data.frame(DATA_C6)

# Data T3

DATA_Cohen <- joined_n[ , c("Sexe", "T3_Math")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T3_Math <- as.numeric(DATA_Cohen$T3_Math)
DATA_C7 <- DATA_Cohen %>%
  cohens_d(T3_Math ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C7)[1] <- "Time"
DATA_T3 <- data.frame(DATA_C7)
rm(DATA_Cohen)
DATA_T1
DATA_T2
DATA_T3


### Joined_n : Cohens d in PbSolving T1 T2 T3

# Data T1

DATA_Cohen <- joined_n[ , c("Sexe", "T1_Resoud_Pb_P")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T1_Resoud_Pb_P <- as.numeric(DATA_Cohen$T1_Resoud_Pb_P)
DATA_C5 <- DATA_Cohen %>%
  cohens_d(T1_Resoud_Pb_P ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1_PbSolv <- data.frame(DATA_C5)
rm(DATA_C5)

# Data T2

DATA_Cohen <- joined_n[ , c("Sexe", "T2_Resoud_Pb_P")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T2_Resoud_Pb_P <- as.numeric(DATA_Cohen$T2_Resoud_Pb_P)
DATA_C5 <- DATA_Cohen %>%
  cohens_d(T2_Resoud_Pb_P ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T2_PbSolv <- data.frame(DATA_C5)
rm(DATA_C5)

# Data T3

DATA_Cohen <- joined_n[ , c("Sexe", "T3_Resoud_Pb_P")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T3_Resoud_Pb_P <- as.numeric(DATA_Cohen$T3_Resoud_Pb_P)
DATA_C5 <- DATA_Cohen %>%
  cohens_d(T3_Resoud_Pb_P ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T3_PbSolv <- data.frame(DATA_C5)
rm(DATA_C5)

DATA_T1_PbSolv
DATA_T2_PbSolv
DATA_T3_PbSolv

### Joined_n : Cohens d in Number line T1 T2 T3

# Data T1

DATA_Cohen <- joined_n[ , c("Sexe", "T1_Ligne_Num_P")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T1_Ligne_Num_P <- as.numeric(DATA_Cohen$T1_Ligne_Num_P)
DATA_C5 <- DATA_Cohen %>%
  cohens_d(T1_Ligne_Num_P ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1_LigneN <- data.frame(DATA_C5)
rm(DATA_C5)

# Data T2

DATA_Cohen <- joined_n[ , c("Sexe", "T2_Ligne_Num_P")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T2_Ligne_Num_P <- as.numeric(DATA_Cohen$T2_Ligne_Num_P)
DATA_C5 <- DATA_Cohen %>%
  cohens_d(T2_Ligne_Num_P ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T2_LigneN <- data.frame(DATA_C5)
rm(DATA_C5)

# Data T3

DATA_Cohen <- joined_n[ , c("Sexe", "T3_Ligne_Num_P")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T3_Ligne_Num_P <- as.numeric(DATA_Cohen$T3_Ligne_Num_P)
DATA_C5 <- DATA_Cohen %>%
  cohens_d(T3_Ligne_Num_P ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T3_LigneN <- data.frame(DATA_C5)
rm(DATA_C5)

DATA_T1_LigneN
DATA_T2_LigneN
DATA_T3_LigneN

### Joined_n : Cohens d in Language T1 T2 T3

# Data T1

DATA_Cohen <- joined_n[ , c("Sexe", "T1_Language")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T1_Language <- as.numeric(DATA_Cohen$T1_Language)
DATA_C5 <- DATA_Cohen %>%
  cohens_d(T1_Language ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T1_Lang <- data.frame(DATA_C5)
rm(DATA_C5)

# Data T2

DATA_Cohen <- joined_n[ , c("Sexe", "T2_Language")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T2_Language <- as.numeric(DATA_Cohen$T2_Language)
DATA_C5 <- DATA_Cohen %>%
  cohens_d(T2_Language ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T2_Lang <- data.frame(DATA_C5)
rm(DATA_C5)

# Data T3

DATA_Cohen <- joined_n[ , c("Sexe", "T3_Language")] 
DATA_Cohen$Sexe    <- as.factor(DATA_Cohen$Sexe)
DATA_Cohen$T3_Language <- as.numeric(DATA_Cohen$T3_Language)
DATA_C5 <- DATA_Cohen %>%
  cohens_d(T3_Language ~ Sexe, var.equal = FALSE, ref.group = "Boys")
colnames(DATA_C5)[1] <- "Time"
DATA_T3_Lang <- data.frame(DATA_C5)
rm(DATA_C5)

DATA_T1_Lang
DATA_T2_Lang
DATA_T3_Lang

# Rassembler les d de Cohen T1, T2, T3

DATA_Cohen_Tot <- rbind(DATA_T1, DATA_T2, DATA_T3, DATA_T1_PbSolv, DATA_T2_PbSolv, DATA_T3_PbSolv,
                        DATA_T1_LigneN, DATA_T2_LigneN, DATA_T3_LigneN, DATA_T1_Lang, DATA_T2_Lang, DATA_T3_Lang)
DATA_Cohen_Tot <- data.frame(DATA_Cohen_Tot)
write_csv2(DATA_Cohen_Tot, file = paste0("~/table/table_S4_CohenD_", ANNEE_COHORTE, "_joined_n_Total.csv"))

rm(DATA_T1, DATA_T2, DATA_T3, DATA_T1_PbSolv, DATA_T2_PbSolv, DATA_T3_PbSolv,
                        DATA_T1_LigneN, DATA_T2_LigneN, DATA_T3_LigneN, DATA_T1_Lang, DATA_T2_Lang, DATA_T3_Lang, DATA_Cohen_Tot)

```




```{r}
### Function - Emergence Gender Gap

emergence <- joined_n

pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- t.test(y ~ g)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("&lt;", "<", format.pval(p, digits=3, eps=0.001)))
}


emergence$Sexe <- as.factor(emergence$Sexe)


### Joined_n : Math T1 T2 T3 and lang and pb solving and number line

# first possibility

table(emergence$Sexe)
emergence$Sexe <- factor(emergence$Sexe, 
         levels=c("Boys","Girls"),
         labels=c("Boys", # Reference
                  "Girls"))
table(emergence$Categ_Etab_CP)
emergence$Categ_Etab_CP <- factor(emergence$Categ_Etab_CP, 
         levels=c("Private","Public", "REP", "REP+"),
         labels=c("Private","Public", "REP", "REP+"))

label(emergence$Sexe)                          <- "Gender"
label(emergence$Categ_Etab_CP)                 <- "School social categories"

units(emergence$Age_CP)                        <- "months"

a <- as.data.frame(table1(~ Age_CP + factor(Categ_Etab_CP) + factor(Sexe) +
                            T1_Math + T2_Math + T3_Math + T1_Resoud_Pb_P + T2_Resoud_Pb_P + T3_Resoud_Pb_P +
                            T1_Ligne_Num_P+ T2_Ligne_Num_P+ T3_Ligne_Num_P+
                            T1_Language + T2_Language + T3_Language | Sexe,
                          data=emergence, overall= F, extra.col=list(`P-value`=pvalue),
                          topclass="Rtable1-zebra"))
a
write_csv2(a, file= paste0("~/table/table_S4_secondEssai_joined_n_", ANNEE_COHORTE, "_mean_diff.csv"))
rm(a)


# Math - Table S4 second possibility - Measuring emergence of gender gap in math


pvalue <- function(x, ...) {
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        p <- t.test(y ~ g)$p.value
    } else {
        p <- chisq.test(table(y, g))$p.value
    }
    c("", sub("<", "&lt;", format.pval(p, digits=5, eps=0.001)))
}

A <- as.data.frame(table1(~ as.numeric(T1_Math) + as.numeric(T2_Math) + as.numeric(T3_Math) +
                            as.numeric(T1_Resoud_Pb_P) + as.numeric(T2_Resoud_Pb_P) + as.numeric(T3_Resoud_Pb_P) +
                            as.numeric(T1_Ligne_Num_P) + as.numeric(T2_Ligne_Num_P) + as.numeric(T3_Ligne_Num_P) +
                            as.numeric(T1_Language) + as.numeric(T2_Language) + as.numeric(T3_Language)
                          | Sexe,
                          data=joined_n,
                          overall= F, extra.col=list(`P-value`=pvalue), 
                          topclass="Rtable1-zebra"))
A
write_csv2(A, file = paste0("~/table/table_S4_thirdessay_", ANNEE_COHORTE, "Emergence_Gender_Gap_joined_n_Math.csv"))


```




# Table S5 - description of tests

#### Cohens d

```{r}
knitr::opts_chunk$set(echo = TRUE)

# Parameters to set before launch of the pipeline

ANNEE_COHORTE = "2018" # 2019 # 2020  # 2021 

library(performance)
library(broom)
library(rstatix)
library(table1)

load(paste0("~/Data/cohort_", ANNEE_COHORTE, "_", IMPUTED,"_joined_n.RData"))

Lang_T1 <- c("T1_Comp_Mots",
             "T1_Comp_Phra",
             "T1_Comp_Text",
             "T1_Manip_Phon",
             "T1_Manip_Syll",
             "T1_Conn_Lettres",
             "T1_Recon_Ecritu_L",
             "T1_Compa_Lettres")

Math_T1 <- c("T1_Ecri_Nombre",
             "T1_Lire_Nombre",
             "T1_Resoud_Pb",
             "T1_Denombrer",
             "T1_Compa_Nombre",
             "T1_Ligne_Num")

Lang_T2 <- c("T2_Comp_Phra",
             "T2_Lire_Mots",
             "T2_Lire_Text",
             "T2_Ecri_Syll",
             "T2_Ecri_Mots",
             "T2_Manip_Phon",
             "T2_Conn_Lettres")
             
Math_T2 <- c("T2_Compa_Nombre",
             "T2_Ligne_Num",
             "T2_Addition",
             "T2_Soustract",
             "T2_Ecri_Nombre",
             "T2_Resoud_Pb")
             
Lang_T3 <- c("T3_Comp_Mots",
             "T3_Comp_Phra",
             "T3_Ecri_Syll",
             "T3_Ecri_Mots",
             "T3_Comp_Phra_Lu",
             "T3_Comp_Text_Lu",
             "T3_Lire_Mots",
             "T3_Lire_Text")

Math_T3 <- c("T3_Assemblage",
             "T3_Ligne_Num",
             "T3_Addition",
             "T3_Soustract",
             "T3_Calcul_Mental",
             "T3_Ecri_Nombre",
             "T3_Lire_Nombre",
             # "T3_Repres_Nb",
             "T3_Resoud_Pb")

Lang_T1_P       <- paste(Lang_T1, "_P", sep="")
Lang_T2_P       <- paste(Lang_T2, "_P", sep="")
Lang_T3_P       <- paste(Lang_T3, "_P", sep="")
Math_T1_P       <- paste(Math_T1, "_P", sep="")
Math_T2_P       <- paste(Math_T2, "_P", sep="")
Math_T3_P       <- paste(Math_T3, "_P", sep="")

# Create a variable list which we want in Table S5

listcohen <- c(Lang_T1_P, Lang_T2_P, Lang_T3_P,
              Math_T1_P, Math_T2_P, Math_T3_P, 
              "T1_Language", "T2_Language", "T3_Language",
              "T1_Math", "T2_Math", "T3_Math")

listVars <- c("ID_Eleve", Lang_T1_P, Lang_T2_P, Lang_T3_P,
              Math_T1_P, Math_T2_P, Math_T3_P, 
              "T1_Language", "T2_Language", "T3_Language",
              "T1_Math", "T2_Math", "T3_Math", "Sexe")

Data_Cohen <- joined_n[ , c(listVars)]

Data_CO <- Data_Cohen %>%
  mutate_at(c(listcohen), as.numeric)

Data_Cohen <- Data_CO

# # # # # # #

library(gtsummary)
library(tidyverse)

CohenD <- function(data, variable, by, ...) {
  
  # Cohen s d, Hedges dg
  
  ES <- effectsize::cohens_d(data[[variable]], factor(data[[by]]),
                             ci=.90,
                             pooled_sd = TRUE,
                             paired = FALSE,
                             correction = TRUE)
  
  # Formatting statistic with CI
  
  est      <- style_sigfig(ES$Cohens_d)
  ci_lower <- style_sigfig(ES$CI_low)
  ci_upper <- style_sigfig(ES$CI_high)
  
  # Returning estimate with CI together
  
  tibble(
    cohens_d = stringr::str_glue("{est} ({ci_lower}, {ci_upper})"),
    interpret_d = stringr::str_glue("{effectsize::interpret_d(ES$Cohens_d, rules = 'cohen1988')}")
  )
  
}


Lang_T1_list <- c(Lang_T1_P, "Sexe")
Lang_T2_list <- c(Lang_T2_P, "Sexe")
Lang_T3_list <- c(Lang_T3_P, "Sexe")
Math_T1_list <- c(Math_T1_P, "Sexe")
Math_T2_list <- c(Math_T2_P, "Sexe")
Math_T3_list <- c(Math_T3_P, "Sexe")



tbl_Lang_T1 <- Data_Cohen %>%
  select(Lang_T1_list) %>%
  tbl_summary(by = Sexe, missing = "no", statistic = all_continuous() ~ "{mean} ; {sd}") %>%
  add_p(test = everything() ~ t.test) %>%
  add_stat(fns = everything() ~ CohenD) %>%
  modify_header(cohen_d = "**ES (90% CI)**", interpret_d = "**Interpretation**") %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = paste0("~/table/", ANNEE_COHORTE,"table_S5_CohensD_tbl_Lang_T1.docx"))
tbl_Lang_T1

tbl_Lang_T2 <-
  Data_Cohen %>%
  select(Lang_T2_list) %>%
  tbl_summary(by = Sexe, missing = "no", statistic = all_continuous() ~ "{mean} ; {sd}") %>%
  add_p(test = everything() ~ t.test) %>%
  add_stat(fns = everything() ~ CohenD) %>%
  modify_header(cohen_d = "**ES (90% CI)**", interpret_d = "**Interpretation**") %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = paste0("~/table/", ANNEE_COHORTE,"table_S5_CohensD_tbl_Lang_T2.docx"))
tbl_Lang_T2

tbl_Lang_T3 <-
  Data_Cohen %>%
  select(Lang_T3_list) %>%
  tbl_summary(by = Sexe, missing = "no", statistic = all_continuous() ~ "{mean} ; {sd}") %>%
  add_p(test = everything() ~ t.test) %>%
  add_stat(fns = everything() ~ CohenD) %>%
  modify_header(cohen_d = "**ES (90% CI)**", interpret_d = "**Interpretation**") %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = paste0("~/table/", ANNEE_COHORTE,"table_S5_CohensD_tbl_Lang_T3.docx"))
tbl_Lang_T3

tbl_Math_T1 <- Data_Cohen %>%
  select(Math_T1_list) %>%
  tbl_summary(by = Sexe, missing = "no", statistic = all_continuous() ~ "{mean} ; {sd}") %>%
  add_p(test = everything() ~ t.test) %>%
  add_stat(fns = everything() ~ CohenD) %>%
  modify_header(cohen_d = "**ES (90% CI)**", interpret_d = "**Interpretation**") %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = paste0("~/table/", ANNEE_COHORTE,"table_S5_CohensD_tbl_Math_T1.docx"))

tbl_Math_T1

tbl_Math_T2 <-
  Data_Cohen %>%
  select(Math_T2_list) %>%
  tbl_summary(by = Sexe, missing = "no", statistic = all_continuous() ~ "{mean} ; {sd}") %>%
  add_p(test = everything() ~ t.test) %>%
  add_stat(fns = everything() ~ CohenD) %>%
  modify_header(cohen_d = "**ES (90% CI)**", interpret_d = "**Interpretation**") %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = paste0("~/table/", ANNEE_COHORTE,"table_S5_CohensD_tbl_Math_T2.docx"))
tbl_Math_T2

tbl_Math_T3 <-
  Data_Cohen %>%
  select(Math_T3_list) %>%
  tbl_summary(by = Sexe, missing = "no", statistic = all_continuous() ~ "{mean} ; {sd}") %>%
  add_p(test = everything() ~ t.test) %>%
  add_stat(fns = everything() ~ CohenD) %>%
  modify_header(cohen_d = "**ES (90% CI)**", interpret_d = "**Interpretation**") %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = paste0("~/table/", ANNEE_COHORTE,"table_S5_CohensD_tbl_Math_T3.docx"))


```


#### Percent success 

```{r}

# Create a variable list which we want in Table 1

listVars <- c("Age_CP", "Taille_Classe", "IPS_Etab_CP",
              Lang_T1_P, Lang_T2_P, Lang_T3_P,
              Math_T1_P, Math_T2_P, Math_T3_P, "T3_Repres_Nb", 
              "T1_Language", "T2_Language", "T3_Language",
              "T1_Math", "T2_Math", "T3_Math")

# Define categorical variables

catVars <- c("Categ_Etab_CP")

table1 <- CreateTableOne(vars = c(listVars, catVars),
                         strata = c("Sexe"),
                         data = joined_n, 
                         factorVars = catVars)
b <- print(table1, 
           quote = TRUE, 
           noSpaces = TRUE,
           showAllLevels = TRUE) # last option is for showing both all categories, for e.g. boys and girls

df1 <- data.frame(b)
write.csv(df1, paste0("~/table/table_S5_joined_n_", ANNEE_COHORTE, "_description_all_tests__boys_vs_girls.csv"), row.names = TRUE)

rm(df1, table1, b)


```

# Table S6 - Sensitivity analysis Single sex classes vs. Mixity classes

Letter to the reviewers

```{r}
knitr::opts_chunk$set(echo = TRUE)

# Data to compare

# joined_imputed

load(paste0("~/Data/cohort_2018_imputed_classes.RData"))

Classes_singlesex_boys <- classes[classes$n_girls == 0, ]
Classes_singlesex_girls <- classes[classes$n_boy == 0, ]
Classes_singlesex <- classes[(classes$n_boy == 0) | (classes$n_girls == 0), ]
Classes_mixity    <- classes[!(classes$n_boy == 0), ]
Classes_mixity    <- Classes_mixity[!(Classes_mixity$n_girls == 0), ]

```

### variables Classes_singlesex vs. Classes_mixity

```{r}
# Selection of variables to compare

Classes_singlesex <- Classes_singlesex[ , c("Age_CP_mean_per_class", "Taille_Classe", "IPS_Etab_CP",
                                            "Categ_Etab_CP",
                                            "T1_Math_mean_per_class", "T2_Math_mean_per_class",
                                            "T3_Math_mean_per_class", "T1_Language_mean_per_class",
                                            "T2_Language_mean_per_class", "T3_Language_mean_per_class")]

Classes_mixity <- Classes_mixity[ , c("Age_CP_mean_per_class", "Taille_Classe", "IPS_Etab_CP",
                                            "Categ_Etab_CP",
                                            "T1_Math_mean_per_class", "T2_Math_mean_per_class",
                                            "T3_Math_mean_per_class", "T1_Language_mean_per_class",
                                            "T2_Language_mean_per_class", "T3_Language_mean_per_class")]


```

# Table S6 - letter to the reviewers : 1rst part

```{r}

# Concatener

Classes_singlesex$Groupe <- 1
Classes_singlesex$Groupe <- as.factor(Classes_singlesex$Groupe)

Classes_mixity$Groupe <- 2
Classes_mixity$Groupe <- as.factor(Classes_mixity$Groupe)

Classes_totale <- rbind(Classes_mixity, Classes_singlesex)

# Create a variable list which we want in Table 1

listVars_BIS <- c("Age_CP_mean_per_class", "Taille_Classe", "IPS_Etab_CP",
                                            "T1_Math_mean_per_class", "T2_Math_mean_per_class",
                                            "T3_Math_mean_per_class", "T1_Language_mean_per_class",
                                            "T2_Language_mean_per_class", "T3_Language_mean_per_class")

catVars <- c("Categ_Etab_CP","Groupe")

table1 <- CreateTableOne(vars = c(listVars_BIS, catVars), 
                         factorVars = catVars,
                         strata = "Groupe",
                         data = Classes_totale) 


a <- print(table1, 
           quote = TRUE, 
           noSpaces = TRUE,
           showAllLevels = TRUE) # last option is for showing both all categories, for e.g. boys and girls
a
df <- data.frame(a)
df
write.csv(df, paste0("~/table/table_S6_sensitivity", ANNEE_COHORTE, "_single_vs_mixity_classes.csv"), row.names = TRUE)


```